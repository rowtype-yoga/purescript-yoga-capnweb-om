// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Apply from "../Control.Apply/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Error_Class from "../Control.Monad.Error.Class/index.js";
import * as Control_Monad_Maybe_Trans from "../Control.Monad.Maybe.Trans/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Time_Duration from "../Data.Time.Duration/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Random from "../Effect.Random/index.js";
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Time_Duration.showMilliseconds);
var show2 = /* #__PURE__ */ Data_Show.show(/* #__PURE__ */ Data_Maybe.showMaybe(Data_Time_Duration.showMilliseconds));
var max = /* #__PURE__ */ Data_Ord.max(Data_Time_Duration.ordMilliseconds);
var greaterThanOrEq = /* #__PURE__ */ Data_Ord.greaterThanOrEq(Data_Time_Duration.ordMilliseconds);
var bindFlipped = /* #__PURE__ */ Control_Bind.bindFlipped(Data_Maybe.bindMaybe);
var greaterThan = /* #__PURE__ */ Data_Ord.greaterThan(Data_Time_Duration.ordMilliseconds);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Time_Duration.semigroupMilliseconds);
var mempty = /* #__PURE__ */ Data_Monoid.mempty(Data_Time_Duration.monoidMilliseconds);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var eq = /* #__PURE__ */ Data_Eq.eq(Data_Time_Duration.eqMilliseconds);
var eq2 = /* #__PURE__ */ Data_Eq.eq(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Time_Duration.eqMilliseconds));
var pure = /* #__PURE__ */ Control_Applicative.pure(Data_Maybe.applicativeMaybe);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var min = /* #__PURE__ */ Data_Ord.min(Data_Time_Duration.ordMilliseconds);
var RetryStatus = function (x) {
    return x;
};
var RetryPolicyM = function (x) {
    return x;
};
var showRetryStatus = {
    show: function (v) {
        return "RetryStatus { " + ("iterNumber: " + (show(v.iterNumber) + (", " + ("cumulativeDelay: " + (show1(v.cumulativeDelay) + (", " + ("previousDelay: " + (show2(v.previousDelay) + "}"))))))));
    }
};
var retryPolicySemigroup = function (dictMonad) {
    var apply = Control_Apply.apply(Control_Monad_Maybe_Trans.applyMaybeT(dictMonad));
    var map1 = Data_Functor.map(Control_Monad_Maybe_Trans.functorMaybeT(((dictMonad.Bind1()).Apply0()).Functor0()));
    return {
        append: function (v) {
            return function (v1) {
                return function (n) {
                    return Control_Monad_Maybe_Trans.runMaybeT(apply(map1(max)(v(n)))(v1(n)));
                };
            };
        }
    };
};
var retryPolicy = function (f) {
    return function (dictMonadAff) {
        var $190 = Control_Applicative.pure(((dictMonadAff.MonadEffect0()).Monad0()).Applicative0());
        return function ($191) {
            return $190(f($191));
        };
    };
};
var retryPolicyMonoid = function (dictMonadAff) {
    var retryPolicySemigroup1 = retryPolicySemigroup((dictMonadAff.MonadEffect0()).Monad0());
    return {
        mempty: retryPolicy(Data_Function["const"](new Data_Maybe.Just(0)))(dictMonadAff),
        Semigroup0: function () {
            return retryPolicySemigroup1;
        }
    };
};
var newtypeRetryStatus = {
    Coercible0: function () {
        return undefined;
    }
};
var limitRetriesByDelay = function (dictMonad) {
    var map1 = Data_Functor.map(((dictMonad.Bind1()).Apply0()).Functor0());
    return function (dictDuration) {
        var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
        return function (d) {
            return function (v) {
                var limit = function (delay) {
                    var $157 = greaterThanOrEq(delay)(fromDuration(d));
                    if ($157) {
                        return Data_Maybe.Nothing.value;
                    };
                    return new Data_Maybe.Just(delay);
                };
                return function (status) {
                    return map1(bindFlipped(limit))(v(status));
                };
            };
        };
    };
};
var limitRetriesByCumulativeDelay = function (dictMonad) {
    var map1 = Data_Functor.map(((dictMonad.Bind1()).Apply0()).Functor0());
    return function (dictDuration) {
        var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
        return function (d) {
            return function (v) {
                var cumulativeDelay = fromDuration(d);
                var limit = function (v1) {
                    return function (curDelay) {
                        if (greaterThan(append1(v1.cumulativeDelay)(curDelay))(cumulativeDelay)) {
                            return Data_Maybe.Nothing.value;
                        };
                        if (Data_Boolean.otherwise) {
                            return new Data_Maybe.Just(curDelay);
                        };
                        throw new Error("Failed pattern match at Effect.Aff.Retry (line 130, column 5 - line 132, column 34): " + [ v1.constructor.name, curDelay.constructor.name ]);
                    };
                };
                return function (status) {
                    return map1(bindFlipped(limit(status)))(v(status));
                };
            };
        };
    };
};
var limitRetries = function (i) {
    return function (dictMonadAff) {
        return retryPolicy(function (v) {
            var $163 = v.iterNumber >= i;
            if ($163) {
                return Data_Maybe.Nothing.value;
            };
            return new Data_Maybe.Just(mempty);
        })(dictMonadAff);
    };
};
var fullJitterBackoff = function (dictMonadAff) {
    var MonadEffect0 = dictMonadAff.MonadEffect0();
    var Monad0 = MonadEffect0.Monad0();
    var bind = Control_Bind.bind(Monad0.Bind1());
    var liftEffect = Effect_Class.liftEffect(MonadEffect0);
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    return function (dictDuration) {
        var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
        return function (duration) {
            return function (v) {
                var v1 = fromDuration(duration);
                var d = (v1 * Data_Number.pow(2.0)(Data_Int.toNumber(v.iterNumber))) / 2.0;
                return bind(liftEffect(Effect_Random.randomRange(0)(d)))(function (rand) {
                    return pure1(new Data_Maybe.Just(d + rand));
                });
            };
        };
    };
};
var fibonacciBackoff = function (dictDuration) {
    var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
    return function (duration) {
        return function (dictMonadAff) {
            var v = fromDuration(duration);
            var fib = function ($copy_v1) {
                return function ($copy_v2) {
                    var $tco_var_v1 = $copy_v1;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(v1, v2) {
                        if (v1 === 0.0) {
                            $tco_done = true;
                            return v2.a;
                        };
                        $tco_var_v1 = v1 - 1;
                        $copy_v2 = {
                            a: v2.b,
                            b: v2.a + v2.b
                        };
                        return;
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_v1, $copy_v2);
                    };
                    return $tco_result;
                };
            };
            return retryPolicy(function (v1) {
                return new Data_Maybe.Just(fib(Data_Int.toNumber(v1.iterNumber) + 1)({
                    a: 0,
                    b: v
                }));
            })(dictMonadAff);
        };
    };
};
var exponentialBackoff = function (dictDuration) {
    var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
    return function (base) {
        return function (dictMonadAff) {
            return retryPolicy(function (v) {
                return new Data_Maybe.Just(unwrap(fromDuration(base)) * Data_Number.pow(2.0)(Data_Int.toNumber(v.iterNumber)));
            })(dictMonadAff);
        };
    };
};
var eqRetryStatus = {
    eq: function (x) {
        return function (y) {
            return eq(x.cumulativeDelay)(y.cumulativeDelay) && x.iterNumber === y.iterNumber && eq2(x.previousDelay)(y.previousDelay);
        };
    }
};
var defaultRetryStatus = /* #__PURE__ */ (function () {
    return {
        iterNumber: 0,
        cumulativeDelay: 0,
        previousDelay: Data_Maybe.Nothing.value
    };
})();
var constantDelay = function (dictDuration) {
    var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
    return function (d) {
        return function (dictMonadAff) {
            return retryPolicy(Data_Function["const"](pure(fromDuration(d))))(dictMonadAff);
        };
    };
};
var capDelay = function (dictMonad) {
    var map1 = Data_Functor.map(((dictMonad.Bind1()).Apply0()).Functor0());
    return function (dictDuration) {
        var fromDuration = Data_Time_Duration.fromDuration(dictDuration);
        return function (limit) {
            return function (v) {
                return function (status) {
                    return map1(map(min(fromDuration(limit))))(v(status));
                };
            };
        };
    };
};
var applyPolicy = function (dictMonadAff) {
    var Monad0 = (dictMonadAff.MonadEffect0()).Monad0();
    var bind = Control_Bind.bind(Monad0.Bind1());
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    return function (v) {
        return function (v1) {
            return bind(v(v1))(function (res) {
                if (res instanceof Data_Maybe.Just) {
                    return pure1(new Data_Maybe.Just({
                        iterNumber: v1.iterNumber + 1 | 0,
                        cumulativeDelay: append1(v1.cumulativeDelay)(res.value0),
                        previousDelay: new Data_Maybe.Just(res.value0)
                    }));
                };
                if (res instanceof Data_Maybe.Nothing) {
                    return pure1(Data_Maybe.Nothing.value);
                };
                throw new Error("Failed pattern match at Effect.Aff.Retry (line 198, column 3 - line 204, column 28): " + [ res.constructor.name ]);
            });
        };
    };
};
var applyAndDelay = function (dictMonadAff) {
    var Monad0 = (dictMonadAff.MonadEffect0()).Monad0();
    var Bind1 = Monad0.Bind1();
    var bind = Control_Bind.bind(Bind1);
    var applyPolicy1 = applyPolicy(dictMonadAff);
    var voidLeft = Data_Functor.voidLeft((Bind1.Apply0()).Functor0());
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    var liftAff = Effect_Aff_Class.liftAff(dictMonadAff);
    return function (policy) {
        return function (retryStatus) {
            return bind(applyPolicy1(policy)(retryStatus))(function (res) {
                if (res instanceof Data_Maybe.Just) {
                    return voidLeft(Data_Maybe.maybe(pure1(Data_Unit.unit))(function ($192) {
                        return liftAff(Effect_Aff.delay($192));
                    })(res.value0.previousDelay))(new Data_Maybe.Just(res.value0));
                };
                if (res instanceof Data_Maybe.Nothing) {
                    return pure1(Data_Maybe.Nothing.value);
                };
                throw new Error("Failed pattern match at Effect.Aff.Retry (line 214, column 5 - line 218, column 30): " + [ res.constructor.name ]);
            });
        };
    };
};
var recovering = function (dictMonadAff) {
    var Monad0 = (dictMonadAff.MonadEffect0()).Monad0();
    var Bind1 = Monad0.Bind1();
    var ifM = Control_Bind.ifM(Bind1);
    var bind = Control_Bind.bind(Bind1);
    var applyAndDelay1 = applyAndDelay(dictMonadAff);
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    return function (dictMonadError) {
        var throwError = Control_Monad_Error_Class.throwError(dictMonadError.MonadThrow0());
        var $$try = Control_Monad_Error_Class["try"](dictMonadError);
        return function (policy) {
            return function (checks) {
                return function (f) {
                    var go = function (status) {
                        var recover = function (chks) {
                            return function (e) {
                                return Data_Maybe.maybe(throwError(e))(handle(e))(Data_Array.uncons(chks));
                            };
                        };
                        var handle = function (e) {
                            return function (hs) {
                                return ifM(hs.head(status)(e))(bind(applyAndDelay1(policy)(status))(Data_Maybe.maybe(throwError(e))(go)))(recover(hs.tail)(e));
                            };
                        };
                        return bind($$try(f(status)))(Data_Either.either(recover(checks))(pure1));
                    };
                    return go(defaultRetryStatus);
                };
            };
        };
    };
};
var retrying = function (dictMonadAff) {
    var Monad0 = (dictMonadAff.MonadEffect0()).Monad0();
    var Bind1 = Monad0.Bind1();
    var bind = Control_Bind.bind(Bind1);
    var ifM = Control_Bind.ifM(Bind1);
    var applyAndDelay1 = applyAndDelay(dictMonadAff);
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    return function (policy) {
        return function (check) {
            return function (action) {
                var go = function (status) {
                    return bind(action(status))(function (res) {
                        return ifM(check(status)(res))(bind(applyAndDelay1(policy)(status))(Data_Maybe.maybe(pure1(res))(go)))(pure1(res));
                    });
                };
                return go(defaultRetryStatus);
            };
        };
    };
};
export {
    RetryStatus,
    RetryPolicyM,
    constantDelay,
    exponentialBackoff,
    fibonacciBackoff,
    fullJitterBackoff,
    capDelay,
    defaultRetryStatus,
    applyAndDelay,
    applyPolicy,
    retryPolicy,
    limitRetries,
    limitRetriesByDelay,
    limitRetriesByCumulativeDelay,
    retrying,
    recovering,
    showRetryStatus,
    eqRetryStatus,
    newtypeRetryStatus,
    retryPolicySemigroup,
    retryPolicyMonoid
};
//# sourceMappingURL=index.js.map
