// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Rec_Class from "../Control.Monad.Rec.Class/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_AVar from "../Effect.Aff.AVar/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Exception from "../Effect.Exception/index.js";
import * as Yoga_Capnweb from "../Yoga.Capnweb/index.js";
import * as Yoga_Om from "../Yoga.Om/index.js";
import * as Yoga_Om_Strom from "../Yoga.Om.Strom/index.js";
var bind = /* #__PURE__ */ Control_Bind.bind(Yoga_Om.bindOm);
var liftAff = /* #__PURE__ */ Effect_Aff_Class.liftAff(Yoga_Om.monadAffOm);
var pure = /* #__PURE__ */ Control_Applicative.pure(Yoga_Om.applicativeOm);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var rpc2 = function (conn) {
    return function (method) {
        return function (a) {
            return function (b) {
                return Yoga_Om_Strom.mkStrom(bind(liftAff(Yoga_Capnweb.call2(conn)(method)(a)(b)))(function (result) {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just([ result ])));
                }));
            };
        };
    };
};
var rpc1 = function (conn) {
    return function (method) {
        return function (a) {
            return Yoga_Om_Strom.mkStrom(bind(liftAff(Yoga_Capnweb.call1(conn)(method)(a)))(function (result) {
                return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just([ result ])));
            }));
        };
    };
};
var rpc0 = function (conn) {
    return function (method) {
        return Yoga_Om_Strom.mkStrom(bind(liftAff(Yoga_Capnweb.call0(conn)(method)))(function (result) {
            return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just([ result ])));
        }));
    };
};
var pullLoop = function (queue) {
    return Yoga_Om_Strom.mkStrom(liftAff(bind1(Effect_Aff_AVar.take(queue))(function (value) {
        return pure1(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just([ value ]), pullLoop(queue))));
    })));
};
var subscribe = function (conn) {
    return function (method) {
        var use = function (res) {
            return pullLoop(res.queue);
        };
        var release = function (res) {
            return liftAff(Effect_Aff.killFiber(Effect_Exception.error("unsubscribed"))(res.fiber));
        };
        var acquire = liftAff(bind1(Effect_Aff_AVar.empty)(function (queue) {
            var cb = function (v) {
                return Effect_Aff.launchAff_(Effect_Aff_AVar.put(v)(queue));
            };
            return bind1(Effect_Aff.forkAff(Yoga_Capnweb.callWithCallback(conn)(method)(cb)))(function (fiber) {
                return pure1({
                    queue: queue,
                    fiber: fiber
                });
            });
        }));
        return Yoga_Om_Strom.bracket(acquire)(release)(use);
    };
};
export {
    subscribe,
    rpc0,
    rpc1,
    rpc2
};
//# sourceMappingURL=index.js.map
