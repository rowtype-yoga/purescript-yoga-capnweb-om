// Generated by purs version 0.15.15
import * as Control_Alt from "../Control.Alt/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Apply from "../Control.Apply/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Category from "../Control.Category/index.js";
import * as Control_Monad_Error_Class from "../Control.Monad.Error.Class/index.js";
import * as Control_Monad_Reader_Class from "../Control.Monad.Reader.Class/index.js";
import * as Control_Monad_Rec_Class from "../Control.Monad.Rec.Class/index.js";
import * as Control_Monad_ST_Internal from "../Control.Monad.ST.Internal/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Array_ST from "../Data.Array.ST/index.js";
import * as Data_Array_ST_Iterator from "../Data.Array.ST.Iterator/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_CatQueue from "../Data.CatQueue/index.js";
import * as Data_DateTime_Instant from "../Data.DateTime.Instant/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_List from "../Data.List/index.js";
import * as Data_List_Types from "../Data.List.Types/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Ordering from "../Data.Ordering/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Time_Duration from "../Data.Time.Duration/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_AVar from "../Effect.Aff.AVar/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Exception from "../Effect.Exception/index.js";
import * as Effect_Now from "../Effect.Now/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Yoga_Om from "../Yoga.Om/index.js";
var $runtime_lazy = function (name, moduleName, init) {
    var state = 0;
    var val;
    return function (lineNumber) {
        if (state === 2) return val;
        if (state === 1) throw new ReferenceError(name + " was needed before it finished initializing (module " + moduleName + ", line " + lineNumber + ")", moduleName, lineNumber);
        state = 1;
        val = init();
        state = 2;
        return val;
    };
};
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var bind = /* #__PURE__ */ Control_Bind.bind(Yoga_Om.bindOm);
var pure = /* #__PURE__ */ Control_Applicative.pure(Yoga_Om.applicativeOm);
var traverse = /* #__PURE__ */ Data_Traversable.traverse(Data_Traversable.traversableArray);
var traverse1 = /* #__PURE__ */ traverse(Yoga_Om.applicativeOm);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(Yoga_Om.bindOm);
var $$void = /* #__PURE__ */ Data_Functor["void"](Yoga_Om.functorOm);
var tailRecM = /* #__PURE__ */ Control_Monad_Rec_Class.tailRecM(Yoga_Om.monadRecOm);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var fromFoldable1 = /* #__PURE__ */ Data_Array.fromFoldable(Data_List_Types.foldableList);
var liftAff = /* #__PURE__ */ Effect_Aff_Class.liftAff(Yoga_Om.monadAffOm);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Yoga_Om.monadEffectOm);
var when = /* #__PURE__ */ Control_Applicative.when(Control_Monad_ST_Internal.applicativeST);
var void1 = /* #__PURE__ */ Data_Functor["void"](Control_Monad_ST_Internal.functorST);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var bind2 = /* #__PURE__ */ Control_Bind.bind(Control_Bind.bindArray);
var pure2 = /* #__PURE__ */ Control_Applicative.pure(Control_Applicative.applicativeArray);
var ask = /* #__PURE__ */ Control_Monad_Reader_Class.ask(Yoga_Om.monadAskOm);
var bind3 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect1 = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var discard3 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var when1 = /* #__PURE__ */ Control_Applicative.when(Effect_Aff.applicativeAff);
var pure3 = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var throwError = /* #__PURE__ */ Control_Monad_Error_Class.throwError(Effect_Aff.monadThrowAff);
var map2 = /* #__PURE__ */ Data_Functor.map(Yoga_Om.functorOm);
var intercalate = /* #__PURE__ */ Data_Array.intercalate(Data_Monoid.monoidArray);
var filterA = /* #__PURE__ */ Data_Array.filterA(Yoga_Om.applicativeOm);
var throwError1 = /* #__PURE__ */ Control_Monad_Error_Class.throwError(Yoga_Om.monadThrowVariantExceptio);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var traverse2 = /* #__PURE__ */ traverse(Effect_Aff.applicativeAff);
var traverse_ = /* #__PURE__ */ Data_Foldable.traverse_(Effect_Aff.applicativeAff)(Data_Foldable.foldableArray);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordInt);
var applySecond = /* #__PURE__ */ Control_Apply.applySecond(Yoga_Om.applyOm);
var delay = /* #__PURE__ */ Yoga_Om.delay(Yoga_Om.monadAffOm)(Data_Time_Duration.durationMilliseconds);
var identity = /* #__PURE__ */ Control_Category.identity(Control_Category.categoryFn);
var StreamId1 = /* #__PURE__ */ (function () {
    function StreamId1() {

    };
    StreamId1.value = new StreamId1();
    return StreamId1;
})();
var StreamId2 = /* #__PURE__ */ (function () {
    function StreamId2() {

    };
    StreamId2.value = new StreamId2();
    return StreamId2;
})();
var DataChunk = /* #__PURE__ */ (function () {
    function DataChunk(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    DataChunk.create = function (value0) {
        return function (value1) {
            return new DataChunk(value0, value1);
        };
    };
    return DataChunk;
})();
var StreamDone = /* #__PURE__ */ (function () {
    function StreamDone(value0) {
        this.value0 = value0;
    };
    StreamDone.create = function (value0) {
        return new StreamDone(value0);
    };
    return StreamDone;
})();
var MergeChunk = /* #__PURE__ */ (function () {
    function MergeChunk(value0) {
        this.value0 = value0;
    };
    MergeChunk.create = function (value0) {
        return new MergeChunk(value0);
    };
    return MergeChunk;
})();
var MergeDone = /* #__PURE__ */ (function () {
    function MergeDone() {

    };
    MergeDone.value = new MergeDone();
    return MergeDone;
})();
var HaltBoth = /* #__PURE__ */ (function () {
    function HaltBoth() {

    };
    HaltBoth.value = new HaltBoth();
    return HaltBoth;
})();
var HaltEither = /* #__PURE__ */ (function () {
    function HaltEither() {

    };
    HaltEither.value = new HaltEither();
    return HaltEither;
})();
var HaltLeft = /* #__PURE__ */ (function () {
    function HaltLeft() {

    };
    HaltLeft.value = new HaltLeft();
    return HaltLeft;
})();
var HaltRight = /* #__PURE__ */ (function () {
    function HaltRight() {

    };
    HaltRight.value = new HaltRight();
    return HaltRight;
})();
var Strom = function (x) {
    return x;
};
var BufferChunk = /* #__PURE__ */ (function () {
    function BufferChunk(value0) {
        this.value0 = value0;
    };
    BufferChunk.create = function (value0) {
        return new BufferChunk(value0);
    };
    return BufferChunk;
})();
var BufferDone = /* #__PURE__ */ (function () {
    function BufferDone() {

    };
    BufferDone.value = new BufferDone();
    return BufferDone;
})();
var functorQueueItem = {
    map: function (f) {
        return function (m) {
            if (m instanceof DataChunk) {
                return new DataChunk(map(f)(m.value0), m.value1);
            };
            if (m instanceof StreamDone) {
                return new StreamDone(m.value0);
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 0, column 0 - line 0, column 0): " + [ m.constructor.name ]);
        };
    }
};
var functorMergeAllItem = {
    map: function (f) {
        return function (m) {
            if (m instanceof MergeChunk) {
                return new MergeChunk(map(f)(m.value0));
            };
            if (m instanceof MergeDone) {
                return MergeDone.value;
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 0, column 0 - line 0, column 0): " + [ m.constructor.name ]);
        };
    }
};
var functorBufferItem = {
    map: function (f) {
        return function (m) {
            if (m instanceof BufferChunk) {
                return new BufferChunk(map(f)(m.value0));
            };
            if (m instanceof BufferDone) {
                return BufferDone.value;
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 0, column 0 - line 0, column 0): " + [ m.constructor.name ]);
        };
    }
};
var eqStreamId = {
    eq: function (x) {
        return function (y) {
            if (x instanceof StreamId1 && y instanceof StreamId1) {
                return true;
            };
            if (x instanceof StreamId2 && y instanceof StreamId2) {
                return true;
            };
            return false;
        };
    }
};
var eq1 = /* #__PURE__ */ Data_Eq.eq(eqStreamId);
var ordStreamId = {
    compare: function (x) {
        return function (y) {
            if (x instanceof StreamId1 && y instanceof StreamId1) {
                return Data_Ordering.EQ.value;
            };
            if (x instanceof StreamId1) {
                return Data_Ordering.LT.value;
            };
            if (y instanceof StreamId1) {
                return Data_Ordering.GT.value;
            };
            if (x instanceof StreamId2 && y instanceof StreamId2) {
                return Data_Ordering.EQ.value;
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 0, column 0 - line 0, column 0): " + [ x.constructor.name, y.constructor.name ]);
        };
    },
    Eq0: function () {
        return eqStreamId;
    }
};
var eqHaltStrategy = {
    eq: function (x) {
        return function (y) {
            if (x instanceof HaltBoth && y instanceof HaltBoth) {
                return true;
            };
            if (x instanceof HaltEither && y instanceof HaltEither) {
                return true;
            };
            if (x instanceof HaltLeft && y instanceof HaltLeft) {
                return true;
            };
            if (x instanceof HaltRight && y instanceof HaltRight) {
                return true;
            };
            return false;
        };
    }
};
var runStrom = function (v) {
    return v.pull;
};
var traverseStrom_ = function (f) {
    return function (stream) {
        var go = function (s) {
            return bind(runStrom(s))(function (step) {
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Done(Data_Unit.unit));
                };
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                    return bind(traverse1(f)(step.value0.value0))(function () {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Unit.unit));
                    });
                };
                if (step instanceof Control_Monad_Rec_Class.Loop) {
                    return discard1((function () {
                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                            return pure(Data_Unit.unit);
                        };
                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                            return $$void(traverse1(f)(step.value0.value0.value0));
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 991, column 9 - line 993, column 48): " + [ step.value0.value0.constructor.name ]);
                    })())(function () {
                        return pure(new Control_Monad_Rec_Class.Loop(step.value0.value1));
                    });
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 984, column 5 - line 994, column 25): " + [ step.constructor.name ]);
            });
        };
        return tailRecM(go)(stream);
    };
};
var traverseMStrom_ = traverseStrom_;
var runFold = function (initial) {
    return function (f) {
        return function (stream) {
            var go = function (v) {
                return bind(runStrom(v.value1))(function (step) {
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(v.value0));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                        return pure(new Control_Monad_Rec_Class.Done(foldl(f)(v.value0)(step.value0.value0)));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Loop) {
                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(v.value0, step.value0.value1)));
                        };
                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(foldl(f)(v.value0)(step.value0.value0.value0), step.value0.value1)));
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 955, column 9 - line 957, column 68): " + [ step.value0.value0.constructor.name ]);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 950, column 5 - line 957, column 68): " + [ step.constructor.name ]);
                });
            };
            return tailRecM(go)(new Data_Tuple.Tuple(initial, stream));
        };
    };
};
var runDrain = /* #__PURE__ */ runFold(Data_Unit.unit)(function (v) {
    return function (v1) {
        return Data_Unit.unit;
    };
});
var runCollect = function (stream) {
    var go = function (v) {
        return bind(runStrom(v.value1))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Array.concat(fromFoldable1(Data_List.reverse(v.value0)))));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Array.concat(fromFoldable1(Data_List.reverse(new Data_List_Types.Cons(step.value0.value0, v.value0))))));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(v.value0, step.value0.value1)));
                };
                if (step.value0.value0 instanceof Data_Maybe.Just) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_List_Types.Cons(step.value0.value0.value0, v.value0), step.value0.value1)));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 970, column 9 - line 972, column 76): " + [ step.value0.value0.constructor.name ]);
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 965, column 5 - line 972, column 76): " + [ step.constructor.name ]);
        });
    };
    return tailRecM(go)(new Data_Tuple.Tuple(Data_List_Types.Nil.value, stream));
};
var mkStrom = function (pull) {
    return {
        pull: pull
    };
};
var repeatOmStromInfinite = function (om) {
    var repeatOmHelper = function (v) {
        return mkStrom(discard1(liftAff(Effect_Aff.delay(0.0)))(function () {
            return bind(om)(function (value) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just([ value ]), repeatOmHelper(Data_Unit.unit))));
            });
        }));
    };
    return repeatOmHelper(Data_Unit.unit);
};
var repeatStromInfinite = function (a) {
    var repeatHelper = function (v) {
        return mkStrom(discard1(liftAff(Effect_Aff.delay(0.0)))(function () {
            var chunk = Data_Array.replicate(10000)(a);
            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(chunk), repeatHelper(Data_Unit.unit))));
        }));
    };
    return repeatHelper(Data_Unit.unit);
};
var scanStrom = function (f) {
    return function (initial) {
        return function (stream) {
            var scanHelper = function (acc) {
                return function (s) {
                    return mkStrom(bind(runStrom(s))(function (step) {
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                            var v = Data_Array.foldl(function (v1) {
                                return function (item) {
                                    var newAcc = f(v1.value0)(item);
                                    return new Data_Tuple.Tuple(newAcc, Data_Array.snoc(v1.value1)(newAcc));
                                };
                            })(new Data_Tuple.Tuple(acc, [  ]))(step.value0.value0);
                            return pure(new Control_Monad_Rec_Class.Done((function () {
                                var $211 = Data_Array["null"](v.value1);
                                if ($211) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(v.value1);
                            })()));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, scanHelper(acc)(step.value0.value1))));
                            };
                            if (step.value0.value0 instanceof Data_Maybe.Just) {
                                var v = Data_Array.foldl(function (v1) {
                                    return function (item) {
                                        var currAcc = f(v1.value0)(item);
                                        return new Data_Tuple.Tuple(currAcc, Data_Array.snoc(v1.value1)(currAcc));
                                    };
                                })(new Data_Tuple.Tuple(acc, [  ]))(step.value0.value0.value0);
                                var $221 = Data_Array["null"](v.value1);
                                if ($221) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, scanHelper(v.value0)(step.value0.value1))));
                                };
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(v.value1), scanHelper(v.value0)(step.value0.value1))));
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 484, column 9 - line 497, column 76): " + [ step.value0.value0.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 469, column 5 - line 497, column 76): " + [ step.constructor.name ]);
                    }));
                };
            };
            return scanHelper(initial)(stream);
        };
    };
};
var succeed = function (a) {
    return mkStrom(pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just([ a ]))));
};
var takeUntilStrom = function (predicate) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                var v = Data_Array.findIndex(predicate)(step.value0.value0);
                if (v instanceof Data_Maybe.Just) {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(Data_Array.take(v.value0 + 1 | 0)(step.value0.value0))));
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(step.value0.value0)));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 631, column 7 - line 633, column 44): " + [ v.constructor.name ]);
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, takeUntilStrom(predicate)(step.value0.value1))));
                };
                if (step.value0.value0 instanceof Data_Maybe.Just) {
                    var v = Data_Array.findIndex(predicate)(step.value0.value0.value0);
                    if (v instanceof Data_Maybe.Just) {
                        return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(Data_Array.take(v.value0 + 1 | 0)(step.value0.value0.value0))));
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step.value0.value0.value0), takeUntilStrom(predicate)(step.value0.value1))));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 637, column 23 - line 639, column 85): " + [ v.constructor.name ]);
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 635, column 7 - line 639, column 85): " + [ step.value0.value0.constructor.name ]);
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 628, column 3 - line 639, column 85): " + [ step.constructor.name ]);
        }));
    };
};
var takeWhileStrom = function (predicate) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                var taken = Data_Array.takeWhile(predicate)(step.value0.value0);
                var $243 = Data_Array.length(taken) < Data_Array.length(step.value0.value0);
                if ($243) {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(taken)));
                };
                return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(taken)));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(step.value0.value0, takeWhileStrom(predicate)(step.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 589, column 3 - line 595, column 97): " + [ step.constructor.name ]);
        }));
    };
};
var tapMStrom = function (f) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return bind(traverse1(f)(step.value0.value0))(function () {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(step.value0.value0)));
                });
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return bind((function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return pure(Data_Maybe.Nothing.value);
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        return bind(traverse1(f)(step.value0.value0.value0))(function () {
                            return pure(new Data_Maybe.Just(step.value0.value0.value0));
                        });
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 451, column 22 - line 455, column 28): " + [ step.value0.value0.constructor.name ]);
                })())(function (tappedChunk) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(tappedChunk, tapMStrom(f)(step.value0.value1))));
                });
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 445, column 3 - line 456, column 56): " + [ step.constructor.name ]);
        }));
    };
};
var tapStrom = function (f) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                var v = map(f)(step.value0.value0);
                return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(step.value0.value0)));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                var tappedChunk = (function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return Data_Maybe.Nothing.value;
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        var v = map(f)(step.value0.value0.value0);
                        return new Data_Maybe.Just(step.value0.value0.value0);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 433, column 23 - line 438, column 25): " + [ step.value0.value0.constructor.name ]);
                })();
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(tappedChunk, tapStrom(f)(step.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 426, column 3 - line 439, column 55): " + [ step.constructor.name ]);
        }));
    };
};
var throttle = function (v) {
    return function (stream) {
        var filterByTime = function (lastEmit) {
            return function (chunk) {
                return bind(Data_Array.foldl(function (acc) {
                    return function (value) {
                        return bind(acc)(function (v1) {
                            return bind(liftEffect(Effect_Now.now))(function (currentTime) {
                                var v2 = Data_DateTime_Instant.unInstant(currentTime);
                                var elapsed = v2 - v1.value0;
                                var $271 = elapsed >= v;
                                if ($271) {
                                    return pure(new Data_Tuple.Tuple(v2, Data_Array.snoc(v1.value1)(value)));
                                };
                                return pure(new Data_Tuple.Tuple(v1.value0, v1.value1));
                            });
                        });
                    };
                })(pure(new Data_Tuple.Tuple(lastEmit, [  ])))(chunk))(function (v1) {
                    return pure(new Data_Tuple.Tuple(v1.value0, v1.value1));
                });
            };
        };
        var throttleWithState = function (lastEmit) {
            return function (s) {
                return mkStrom(bind(runStrom(s))(function (step) {
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                        return bind(filterByTime(lastEmit)(step.value0.value0))(function (v1) {
                            return pure(new Control_Monad_Rec_Class.Done((function () {
                                var $280 = Data_Array["null"](v1.value1);
                                if ($280) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(v1.value1);
                            })()));
                        });
                    };
                    if (step instanceof Control_Monad_Rec_Class.Loop) {
                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, throttleWithState(lastEmit)(step.value0.value1))));
                        };
                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                            return bind(filterByTime(lastEmit)(step.value0.value0.value0))(function (v1) {
                                var $287 = Data_Array["null"](v1.value1);
                                if ($287) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, throttleWithState(v1.value0)(step.value0.value1))));
                                };
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(v1.value1), throttleWithState(v1.value0)(step.value0.value1))));
                            });
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 911, column 9 - line 916, column 89): " + [ step.value0.value0.constructor.name ]);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 905, column 5 - line 916, column 89): " + [ step.constructor.name ]);
                }));
            };
        };
        return throttleWithState(0.0)(stream);
    };
};
var unfoldOmStrom = function (f) {
    return function (seed) {
        var go = bind(f(seed))(function (result) {
            if (result instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (result instanceof Data_Maybe.Just) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just([ result.value0.value0 ]), unfoldOmStrom(f)(result.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 390, column 5 - line 392, column 99): " + [ result.constructor.name ]);
        });
        return mkStrom(go);
    };
};
var unfoldStrom = function (f) {
    return function (seed) {
        var buildChunk = function (seed$prime) {
            return function (size) {
                return (function __do() {
                    var arr = Data_Array_ST.unsafeThaw([  ])();
                    var seedRef = {
                        value: seed$prime
                    };
                    var stoppedRef = {
                        value: false
                    };
                    var iter = Data_Array_ST_Iterator.iterator(function (i) {
                        var $298 = i < size;
                        if ($298) {
                            return new Data_Maybe.Just(i);
                        };
                        return Data_Maybe.Nothing.value;
                    })();
                    Data_Array_ST_Iterator.iterate(iter)(function (v) {
                        return function __do() {
                            return when(!stoppedRef.value)(function __do() {
                                var v1 = f(seedRef.value);
                                if (v1 instanceof Data_Maybe.Nothing) {
                                    return void1(Control_Monad_ST_Internal.write(true)(stoppedRef))();
                                };
                                if (v1 instanceof Data_Maybe.Just) {
                                    void1(Data_Array_ST.push(v1.value0.value0)(arr))();
                                    return void1(Control_Monad_ST_Internal.write(v1.value0.value1)(seedRef))();
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 374, column 9 - line 378, column 45): " + [ v1.constructor.name ]);
                            })();
                        };
                    })();
                    var frozen = Data_Array_ST.unsafeFreeze(arr)();
                    return {
                        values: frozen,
                        finalSeed: (function () {
                            if (stoppedRef.value) {
                                return Data_Maybe.Nothing.value;
                            };
                            return new Data_Maybe.Just(seedRef.value);
                        })()
                    };
                })();
            };
        };
        var unfoldHelper = function (currentSeed) {
            return mkStrom((function () {
                var chunk = buildChunk(currentSeed)(10000);
                if (chunk.finalSeed instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Done((function () {
                        var $305 = Data_Array["null"](chunk.values);
                        if ($305) {
                            return Data_Maybe.Nothing.value;
                        };
                        return new Data_Maybe.Just(chunk.values);
                    })()));
                };
                if (chunk.finalSeed instanceof Data_Maybe.Just) {
                    var $306 = Data_Array["null"](chunk.values);
                    if ($306) {
                        return runStrom(unfoldHelper(chunk.finalSeed.value0));
                    };
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(chunk.values), unfoldHelper(chunk.finalSeed.value0))));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 359, column 5 - line 363, column 76): " + [ chunk.finalSeed.constructor.name ]);
            })());
        };
        return unfoldHelper(seed);
    };
};
var zipWithStrom = function (f) {
    return function (s1) {
        return function (s2) {
            return mkStrom(bind(runStrom(s1))(function (step1) {
                return bind(runStrom(s2))(function (step2) {
                    if (step1 instanceof Control_Monad_Rec_Class.Done && (step1.value0 instanceof Data_Maybe.Just && (step2 instanceof Control_Monad_Rec_Class.Done && step2.value0 instanceof Data_Maybe.Just))) {
                        var zipped = Data_Array.zipWith(f)(step1.value0.value0)(step2.value0.value0);
                        return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(zipped)));
                    };
                    if (step1 instanceof Control_Monad_Rec_Class.Done && step1.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (step2 instanceof Control_Monad_Rec_Class.Done && step2.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (step1 instanceof Control_Monad_Rec_Class.Loop && step2 instanceof Control_Monad_Rec_Class.Loop) {
                        if (step1.value0.value0 instanceof Data_Maybe.Just && step2.value0.value0 instanceof Data_Maybe.Just) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(Data_Array.zipWith(f)(step1.value0.value0.value0)(step2.value0.value0.value0)), zipWithStrom(f)(step1.value0.value1)(step2.value0.value1))));
                        };
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, zipWithStrom(f)(step1.value0.value1)(step2.value0.value1))));
                    };
                    if (step1 instanceof Control_Monad_Rec_Class.Loop) {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, zipWithStrom(f)(step1.value0.value1)(s2))));
                    };
                    if (step2 instanceof Control_Monad_Rec_Class.Loop) {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, zipWithStrom(f)(s1)(step2.value0.value1))));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1066, column 3 - line 1078, column 83): " + [ step1.constructor.name, step2.constructor.name ]);
                });
            }));
        };
    };
};
var zipStrom = /* #__PURE__ */ (function () {
    return zipWithStrom(Data_Tuple.Tuple.create);
})();
var functorStrom = {
    map: function (f) {
        return function (stream) {
            return mkStrom(bind(runStrom(stream))(function (step) {
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                };
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(map(f)(step.value0.value0))));
                };
                if (step instanceof Control_Monad_Rec_Class.Loop) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(map1(map(f))(step.value0.value0), Data_Functor.map(functorStrom)(f)(step.value0.value1))));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1705, column 9 - line 1708, column 122): " + [ step.constructor.name ]);
            }));
        };
    }
};
var altStrom = {
    alt: function (s1) {
        return function (s2) {
            return mkStrom(bind(runStrom(s1))(function (step) {
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                    return runStrom(s2);
                };
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step.value0.value0), s2)));
                };
                if (step instanceof Control_Monad_Rec_Class.Loop) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(step.value0.value0, Control_Alt.alt(altStrom)(step.value0.value1)(s2))));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1780, column 9 - line 1783, column 85): " + [ step.constructor.name ]);
            }));
        };
    },
    Functor0: function () {
        return functorStrom;
    }
};
var applyStrom = {
    apply: function (fs) {
        return function (as) {
            return mkStrom(bind(runStrom(fs))(function (stepF) {
                return bind(runStrom(as))(function (stepA) {
                    if (stepF instanceof Control_Monad_Rec_Class.Done && (stepF.value0 instanceof Data_Maybe.Just && (stepA instanceof Control_Monad_Rec_Class.Done && stepA.value0 instanceof Data_Maybe.Just))) {
                        var results = bind2(stepF.value0.value0)(function (f) {
                            return bind2(stepA.value0.value0)(function (a) {
                                return pure2(f(a));
                            });
                        });
                        return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(results)));
                    };
                    if (stepF instanceof Control_Monad_Rec_Class.Done && stepF.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (stepA instanceof Control_Monad_Rec_Class.Done && stepA.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (stepF instanceof Control_Monad_Rec_Class.Loop && stepA instanceof Control_Monad_Rec_Class.Loop) {
                        if (stepF.value0.value0 instanceof Data_Maybe.Just && stepA.value0.value0 instanceof Data_Maybe.Just) {
                            var applied = bind2(stepF.value0.value0.value0)(function (f) {
                                return bind2(stepA.value0.value0.value0)(function (a) {
                                    return pure2(f(a));
                                });
                            });
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(applied), Control_Apply.apply(applyStrom)(stepF.value0.value1)(stepA.value0.value1))));
                        };
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, Control_Apply.apply(applyStrom)(stepF.value0.value1)(stepA.value0.value1))));
                    };
                    if (stepF instanceof Control_Monad_Rec_Class.Loop) {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, Control_Apply.apply(applyStrom)(stepF.value0.value1)(as))));
                    };
                    if (stepA instanceof Control_Monad_Rec_Class.Loop) {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, Control_Apply.apply(applyStrom)(fs)(stepA.value0.value1))));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1715, column 11 - line 1737, column 80): " + [ stepF.constructor.name, stepA.constructor.name ]);
                });
            }));
        };
    },
    Functor0: function () {
        return functorStrom;
    }
};
var applicativeStrom = {
    pure: succeed,
    Apply0: function () {
        return applyStrom;
    }
};
var plusStrom = /* #__PURE__ */ (function () {
    return {
        empty: mkStrom(pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value))),
        Alt0: function () {
            return altStrom;
        }
    };
})();
var alternativeStrom = {
    Applicative0: function () {
        return applicativeStrom;
    },
    Plus1: function () {
        return plusStrom;
    }
};
var semigroupStrom = {
    append: function (s1) {
        return function (s2) {
            return mkStrom(bind(runStrom(s1))(function (step) {
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                    return runStrom(s2);
                };
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step.value0.value0), s2)));
                };
                if (step instanceof Control_Monad_Rec_Class.Loop) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(step.value0.value0, Data_Semigroup.append(semigroupStrom)(step.value0.value1)(s2))));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1768, column 9 - line 1771, column 84): " + [ step.constructor.name ]);
            }));
        };
    }
};
var mergeNDWithStrategy = function (bufferCapacity) {
    return function (strategy) {
        return function (stream1) {
            return function (stream2) {
                return mkStrom(bind(ask)(function (ctx) {
                    return liftAff(bind3(liftEffect1(Effect_Ref["new"](Data_CatQueue.empty)))(function (bufferRef) {
                        return bind3(liftEffect1(Effect_Ref["new"](0)))(function (sizeRef) {
                            return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (mutex) {
                                return bind3(Effect_Aff_AVar.empty)(function (notEmpty) {
                                    return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (notFull) {
                                        var shouldStop = function (doneLeft) {
                                            return function (doneRight) {
                                                if (strategy instanceof HaltBoth) {
                                                    return doneLeft && doneRight;
                                                };
                                                if (strategy instanceof HaltEither) {
                                                    return doneLeft || doneRight;
                                                };
                                                if (strategy instanceof HaltLeft) {
                                                    return doneLeft;
                                                };
                                                if (strategy instanceof HaltRight) {
                                                    return doneRight;
                                                };
                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1355, column 9 - line 1359, column 33): " + [ strategy.constructor.name ]);
                                            };
                                        };
                                        var enqueue = function (item) {
                                            return discard3(Effect_Aff_AVar.take(notFull))(function () {
                                                return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                    return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                        var wasEmpty = size === 0;
                                                        return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                            return discard3(liftEffect1(Effect_Ref.write(Data_CatQueue.snoc(buf)(item))(bufferRef)))(function () {
                                                                return discard3(liftEffect1(Effect_Ref.write(size + 1 | 0)(sizeRef)))(function () {
                                                                    return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                        return discard3(when1(wasEmpty)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                            return when1((size + 1 | 0) < bufferCapacity)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull));
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        };
                                        var $lazy_dequeue = $runtime_lazy("dequeue", "Yoga.Om.Strom", function () {
                                            return discard3(Effect_Aff_AVar.take(notEmpty))(function () {
                                                return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                    return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                        return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                            var v = Data_CatQueue.uncons(buf);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                    return $lazy_dequeue(1380);
                                                                });
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                return discard3(liftEffect1(Effect_Ref.write(v.value0.value1)(bufferRef)))(function () {
                                                                    return discard3(liftEffect1(Effect_Ref.write(size - 1 | 0)(sizeRef)))(function () {
                                                                        var hasMore = (size - 1 | 0) > 0;
                                                                        var wasFull = size === bufferCapacity;
                                                                        return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                            return discard3(when1(hasMore)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                                return discard3(when1(wasFull)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull)))(function () {
                                                                                    return pure3(v.value0.value0);
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            };
                                                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 1377, column 9 - line 1389, column 22): " + [ v.constructor.name ]);
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                        var dequeue = $lazy_dequeue(1372);
                                        return bind3(Effect_Aff.forkAff((function () {
                                            var producer = function (s) {
                                                return bind3(Yoga_Om.runReader(ctx)(runStrom(s)))(function (stepResult) {
                                                    return bind3(Data_Either.either(function (v) {
                                                        return throwError(Effect_Exception.error("Stream error"));
                                                    })(pure3)(stepResult))(function (step) {
                                                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                                            return enqueue(new StreamDone(StreamId1.value));
                                                        };
                                                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                                            return discard3(enqueue(new DataChunk(step.value0.value0, StreamId1.value)))(function () {
                                                                return enqueue(new StreamDone(StreamId1.value));
                                                            });
                                                        };
                                                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                                                            return discard3((function () {
                                                                if (step.value0.value0 instanceof Data_Maybe.Just) {
                                                                    return enqueue(new DataChunk(step.value0.value0.value0, StreamId1.value));
                                                                };
                                                                if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                                                    return pure3(Data_Unit.unit);
                                                                };
                                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1404, column 15 - line 1406, column 37): " + [ step.value0.value0.constructor.name ]);
                                                            })())(function () {
                                                                return producer(step.value0.value1);
                                                            });
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1397, column 11 - line 1407, column 28): " + [ step.constructor.name ]);
                                                    });
                                                });
                                            };
                                            return producer(stream1);
                                        })()))(function (fiber1) {
                                            return bind3(Effect_Aff.forkAff((function () {
                                                var producer = function (s) {
                                                    return bind3(Yoga_Om.runReader(ctx)(runStrom(s)))(function (stepResult) {
                                                        return bind3(Data_Either.either(function (v) {
                                                            return throwError(Effect_Exception.error("Stream error"));
                                                        })(pure3)(stepResult))(function (step) {
                                                            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                                                return enqueue(new StreamDone(StreamId2.value));
                                                            };
                                                            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                                                return discard3(enqueue(new DataChunk(step.value0.value0, StreamId2.value)))(function () {
                                                                    return enqueue(new StreamDone(StreamId2.value));
                                                                });
                                                            };
                                                            if (step instanceof Control_Monad_Rec_Class.Loop) {
                                                                return discard3((function () {
                                                                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                                                                        return enqueue(new DataChunk(step.value0.value0.value0, StreamId2.value));
                                                                    };
                                                                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                                                        return pure3(Data_Unit.unit);
                                                                    };
                                                                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1423, column 15 - line 1425, column 37): " + [ step.value0.value0.constructor.name ]);
                                                                })())(function () {
                                                                    return producer(step.value0.value1);
                                                                });
                                                            };
                                                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 1416, column 11 - line 1426, column 28): " + [ step.constructor.name ]);
                                                        });
                                                    });
                                                };
                                                return producer(stream2);
                                            })()))(function (fiber2) {
                                                var consumer = function (doneLeft) {
                                                    return function (doneRight) {
                                                        return mkStrom(liftAff((function () {
                                                            var $400 = shouldStop(doneLeft)(doneRight);
                                                            if ($400) {
                                                                return discard3(Effect_Aff.killFiber(Effect_Exception.error("done"))(fiber1))(function () {
                                                                    return discard3(Effect_Aff.killFiber(Effect_Exception.error("done"))(fiber2))(function () {
                                                                        return pure3(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                                                                    });
                                                                });
                                                            };
                                                            return bind3(dequeue)(function (msg) {
                                                                if (msg instanceof StreamDone) {
                                                                    var doneRight$prime = doneRight || eq1(msg.value0)(StreamId2.value);
                                                                    var doneLeft$prime = doneLeft || eq1(msg.value0)(StreamId1.value);
                                                                    return bind3(Yoga_Om.runReader(ctx)(runStrom(consumer(doneLeft$prime)(doneRight$prime))))(function (stepResult) {
                                                                        return Data_Either.either(function (v) {
                                                                            return throwError(Effect_Exception.error("Consumer error"));
                                                                        })(pure3)(stepResult);
                                                                    });
                                                                };
                                                                if (msg instanceof DataChunk) {
                                                                    return pure3(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(msg.value0), consumer(doneLeft)(doneRight))));
                                                                };
                                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1439, column 11 - line 1449, column 76): " + [ msg.constructor.name ]);
                                                            });
                                                        })()));
                                                    };
                                                };
                                                return bind3(Yoga_Om.runReader(ctx)(runStrom(consumer(false)(false))))(function (stepResult) {
                                                    return Data_Either.either(function (v) {
                                                        return throwError(Effect_Exception.error("Consumer init error"));
                                                    })(pure3)(stepResult);
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    }));
                }));
            };
        };
    };
};
var mergeNDWith = function (bufferCapacity) {
    return mergeNDWithStrategy(bufferCapacity)(HaltBoth.value);
};
var mergeND = /* #__PURE__ */ mergeNDWith(1024);
var mergeHaltRight = /* #__PURE__ */ (function () {
    return mergeNDWithStrategy(1024)(HaltRight.value);
})();
var mergeHaltLeft = /* #__PURE__ */ (function () {
    return mergeNDWithStrategy(1024)(HaltLeft.value);
})();
var mergeHaltEither = /* #__PURE__ */ (function () {
    return mergeNDWithStrategy(1024)(HaltEither.value);
})();
var race = mergeHaltEither;
var merge = /* #__PURE__ */ mergeNDWith(1024);
var mapStrom = function (f) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(map(f)(step.value0.value0))));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(map1(map(f))(step.value0.value0), mapStrom(f)(step.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 402, column 3 - line 405, column 113): " + [ step.constructor.name ]);
        }));
    };
};
var mergeWith = function (strategy) {
    return function (f) {
        return function (g) {
            return function (s1) {
                return function (s2) {
                    return mergeNDWithStrategy(1024)(strategy)(mapStrom(f)(s1))(mapStrom(g)(s2));
                };
            };
        };
    };
};
var mapMStrom = function (f) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return bind(traverse1(f)(step.value0.value0))(function (mapped) {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(mapped)));
                });
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return bind((function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return pure(Data_Maybe.Nothing.value);
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        return map2(Data_Maybe.Just.create)(traverse1(f)(step.value0.value0.value0));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 417, column 22 - line 419, column 48): " + [ step.value0.value0.constructor.name ]);
                })())(function (mappedChunk) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(mappedChunk, mapMStrom(f)(step.value0.value1))));
                });
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 411, column 3 - line 420, column 56): " + [ step.constructor.name ]);
        }));
    };
};
var mapPar = function (concurrency) {
    return function (f) {
        return function (stream) {
            if (concurrency <= 1) {
                return mapMStrom(f)(stream);
            };
            if (Data_Boolean.otherwise) {
                var chunksOf = function (n) {
                    return function (arr) {
                        if (n <= 0 || Data_Array["null"](arr)) {
                            return [  ];
                        };
                        if (Data_Boolean.otherwise) {
                            var rest = Data_Array.drop(n)(arr);
                            var group = Data_Array.take(n)(arr);
                            var $426 = Data_Array["null"](group);
                            if ($426) {
                                return [  ];
                            };
                            return Data_Array.cons(group)(chunksOf(n)(rest));
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1566, column 7 - line 1566, column 62): " + [ n.constructor.name, arr.constructor.name ]);
                    };
                };
                return mkStrom(bind(runStrom(stream))(function (step) {
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                        var groups = chunksOf(concurrency)(step.value0.value0);
                        return bind(traverse1(function (group) {
                            return Yoga_Om.inParallel(map(f)(group));
                        })(groups))(function (results) {
                            return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(Data_Array.concat(results))));
                        });
                    };
                    if (step instanceof Control_Monad_Rec_Class.Loop) {
                        return bind((function () {
                            if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                return pure(Data_Maybe.Nothing.value);
                            };
                            if (step.value0.value0 instanceof Data_Maybe.Just) {
                                var groups = chunksOf(concurrency)(step.value0.value0.value0);
                                return bind(traverse1(function (group) {
                                    return Yoga_Om.inParallel(map(f)(group));
                                })(groups))(function (results) {
                                    return pure(new Data_Maybe.Just(Data_Array.concat(results)));
                                });
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 1558, column 28 - line 1563, column 51): " + [ step.value0.value0.constructor.name ]);
                        })())(function (mappedChunk) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(mappedChunk, mapPar(concurrency)(f)(step.value0.value1))));
                        });
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1550, column 9 - line 1564, column 71): " + [ step.constructor.name ]);
                }));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 1544, column 1 - line 1544, column 95): " + [ concurrency.constructor.name, f.constructor.name, stream.constructor.name ]);
        };
    };
};
var mapParUnordered = mapPar;
var mapMParUnordered = mapParUnordered;
var mapMPar = mapPar;
var mapAccumStrom = function (f) {
    return function (initial) {
        return function (stream) {
            var mapAccumHelper = function (state) {
                return function (s) {
                    return mkStrom(bind(runStrom(s))(function (step) {
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                            var v = Data_Array.foldl(function (v1) {
                                return function (a) {
                                    var v2 = f(v1.value0)(a);
                                    return new Data_Tuple.Tuple(v2.value0, Data_Array.snoc(v1.value1)(v2.value1));
                                };
                            })(new Data_Tuple.Tuple(state, [  ]))(step.value0.value0);
                            return pure(new Control_Monad_Rec_Class.Done((function () {
                                var $445 = Data_Array["null"](v.value1);
                                if ($445) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(v.value1);
                            })()));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, mapAccumHelper(state)(step.value0.value1))));
                            };
                            if (step.value0.value0 instanceof Data_Maybe.Just) {
                                var v = Data_Array.foldl(function (v1) {
                                    return function (a) {
                                        var v2 = f(v1.value0)(a);
                                        return new Data_Tuple.Tuple(v2.value0, Data_Array.snoc(v1.value1)(v2.value1));
                                    };
                                })(new Data_Tuple.Tuple(state, [  ]))(step.value0.value0.value0);
                                var $458 = Data_Array["null"](v.value1);
                                if ($458) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, mapAccumHelper(v.value0)(step.value0.value1))));
                                };
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(v.value1), mapAccumHelper(v.value0)(step.value0.value1))));
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 519, column 9 - line 532, column 82): " + [ step.value0.value0.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 505, column 5 - line 532, column 82): " + [ step.constructor.name ]);
                    }));
                };
            };
            return mapAccumHelper(initial)(stream);
        };
    };
};
var iterateStromInfinite = function (f) {
    return function (initial) {
        var iterateHelper = function (current) {
            return mkStrom(discard1(liftAff(Effect_Aff.delay(0.0)))(function () {
                var result = (function __do() {
                    var arr = Data_Array_ST.unsafeThaw([  ])();
                    var valRef = {
                        value: current
                    };
                    var iter = Data_Array_ST_Iterator.iterator(function (i) {
                        var $465 = i < 10000;
                        if ($465) {
                            return new Data_Maybe.Just(i);
                        };
                        return Data_Maybe.Nothing.value;
                    })();
                    Data_Array_ST_Iterator.iterate(iter)(function (v) {
                        return function __do() {
                            void1(Data_Array_ST.push(valRef.value)(arr))();
                            return void1(Control_Monad_ST_Internal.modify(f)(valRef))();
                        };
                    })();
                    var frozen = Data_Array_ST.unsafeFreeze(arr)();
                    return {
                        arr: frozen,
                        nextVal: valRef.value
                    };
                })();
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(result.arr), iterateHelper(result.nextVal))));
            }));
        };
        return iterateHelper(initial);
    };
};
var intersperse = function (separator) {
    return function (stream) {
        var intersperseHelper = function (isFirst) {
            return function (s) {
                return mkStrom(bind(runStrom(s))(function (step) {
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                        var withSeparators = (function () {
                            if (isFirst) {
                                return intercalate([ separator ])(map(Data_Array.singleton)(step.value0.value0));
                            };
                            return Data_Array.cons(separator)(intercalate([ separator ])(map(Data_Array.singleton)(step.value0.value0)));
                        })();
                        return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(withSeparators)));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Loop) {
                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, intersperseHelper(isFirst)(step.value0.value1))));
                        };
                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                            var withSeparators = (function () {
                                if (isFirst) {
                                    return intercalate([ separator ])(map(Data_Array.singleton)(step.value0.value0.value0));
                                };
                                return Data_Array.cons(separator)(intercalate([ separator ])(map(Data_Array.singleton)(step.value0.value0.value0)));
                            })();
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(withSeparators), intersperseHelper(false)(step.value0.value1))));
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1116, column 9 - line 1123, column 84): " + [ step.value0.value0.constructor.name ]);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1107, column 5 - line 1123, column 84): " + [ step.constructor.name ]);
                }));
            };
        };
        return intersperseHelper(true)(stream);
    };
};
var interleave = function (s1) {
    return function (s2) {
        var interleaveHelper = function (preferFirst) {
            return function (first) {
                return function (second) {
                    return mkStrom((function () {
                        if (preferFirst) {
                            return bind(runStrom(first))(function (step1) {
                                if (step1 instanceof Control_Monad_Rec_Class.Done && step1.value0 instanceof Data_Maybe.Nothing) {
                                    return runStrom(second);
                                };
                                if (step1 instanceof Control_Monad_Rec_Class.Done && step1.value0 instanceof Data_Maybe.Just) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step1.value0.value0), interleaveHelper(false)(second)(first))));
                                };
                                if (step1 instanceof Control_Monad_Rec_Class.Loop) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(step1.value0.value0, interleaveHelper(false)(second)(step1.value0.value1))));
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1088, column 7 - line 1092, column 79): " + [ step1.constructor.name ]);
                            });
                        };
                        return bind(runStrom(second))(function (step2) {
                            if (step2 instanceof Control_Monad_Rec_Class.Done && step2.value0 instanceof Data_Maybe.Nothing) {
                                return runStrom(first);
                            };
                            if (step2 instanceof Control_Monad_Rec_Class.Done && step2.value0 instanceof Data_Maybe.Just) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step2.value0.value0), interleaveHelper(true)(first)(second))));
                            };
                            if (step2 instanceof Control_Monad_Rec_Class.Loop) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(step2.value0.value0, interleaveHelper(true)(first)(step2.value0.value1))));
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 1095, column 7 - line 1099, column 77): " + [ step2.constructor.name ]);
                        });
                    })());
                };
            };
        };
        return interleaveHelper(true)(s1)(s2);
    };
};
var groupByStrom = function (dictEq) {
    var eq2 = Data_Eq.eq(dictEq);
    return function (keyFn) {
        return function (stream) {
            var groupByHelper = function (lastKey) {
                return function (buf) {
                    return function (s) {
                        return mkStrom(bind(runStrom(s))(function (step) {
                            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Done((function () {
                                    var $493 = Data_Array["null"](buf);
                                    if ($493) {
                                        return Data_Maybe.Nothing.value;
                                    };
                                    return new Data_Maybe.Just([ buf ]);
                                })()));
                            };
                            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                var v = Data_Array.foldl(function (v1) {
                                    return function (item) {
                                        var itemKey = keyFn(item);
                                        if (v1.value0 instanceof Data_Maybe.Nothing) {
                                            return new Data_Tuple.Tuple(new Data_Maybe.Just(itemKey), {
                                                groups: [  ],
                                                buffer: [ item ]
                                            });
                                        };
                                        if (v1.value0 instanceof Data_Maybe.Just) {
                                            var $497 = eq2(v1.value0.value0)(itemKey);
                                            if ($497) {
                                                return new Data_Tuple.Tuple(new Data_Maybe.Just(itemKey), {
                                                    groups: v1.value1.groups,
                                                    buffer: Data_Array.snoc(v1.value1.buffer)(item)
                                                });
                                            };
                                            return new Data_Tuple.Tuple(new Data_Maybe.Just(itemKey), {
                                                groups: Data_Array.snoc(v1.value1.groups)(v1.value1.buffer),
                                                buffer: [ item ]
                                            });
                                        };
                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 823, column 19 - line 827, column 110): " + [ v1.value0.constructor.name ]);
                                    };
                                })(new Data_Tuple.Tuple(lastKey, {
                                    groups: [  ],
                                    buffer: buf
                                }))(step.value0.value0);
                                var allGroups = (function () {
                                    var $502 = Data_Array["null"](v.value1.buffer);
                                    if ($502) {
                                        return v.value1.groups;
                                    };
                                    return Data_Array.snoc(v.value1.groups)(v.value1.buffer);
                                })();
                                return pure(new Control_Monad_Rec_Class.Done((function () {
                                    var $503 = Data_Array["null"](allGroups);
                                    if ($503) {
                                        return Data_Maybe.Nothing.value;
                                    };
                                    return new Data_Maybe.Just(allGroups);
                                })()));
                            };
                            if (step instanceof Control_Monad_Rec_Class.Loop) {
                                if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, groupByHelper(lastKey)(buf)(step.value0.value1))));
                                };
                                if (step.value0.value0 instanceof Data_Maybe.Just) {
                                    var v = Data_Array.foldl(function (v1) {
                                        return function (item) {
                                            var itemKey = keyFn(item);
                                            if (v1.value0 instanceof Data_Maybe.Nothing) {
                                                return new Data_Tuple.Tuple(new Data_Maybe.Just(itemKey), {
                                                    groups: [  ],
                                                    buffer: [ item ]
                                                });
                                            };
                                            if (v1.value0 instanceof Data_Maybe.Just) {
                                                var $511 = eq2(v1.value0.value0)(itemKey);
                                                if ($511) {
                                                    return new Data_Tuple.Tuple(new Data_Maybe.Just(itemKey), {
                                                        groups: v1.value1.groups,
                                                        buffer: Data_Array.snoc(v1.value1.buffer)(item)
                                                    });
                                                };
                                                return new Data_Tuple.Tuple(new Data_Maybe.Just(itemKey), {
                                                    groups: Data_Array.snoc(v1.value1.groups)(v1.value1.buffer),
                                                    buffer: [ item ]
                                                });
                                            };
                                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 844, column 23 - line 848, column 114): " + [ v1.value0.constructor.name ]);
                                        };
                                    })(new Data_Tuple.Tuple(lastKey, {
                                        groups: [  ],
                                        buffer: buf
                                    }))(step.value0.value0.value0);
                                    var $516 = Data_Array["null"](v.value1.groups);
                                    if ($516) {
                                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, groupByHelper(v.value0)(v.value1.buffer)(step.value0.value1))));
                                    };
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(v.value1.groups), groupByHelper(v.value0)(v.value1.buffer)(step.value0.value1))));
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 836, column 9 - line 853, column 99): " + [ step.value0.value0.constructor.name ]);
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 814, column 5 - line 853, column 99): " + [ step.constructor.name ]);
                        }));
                    };
                };
            };
            return groupByHelper(Data_Maybe.Nothing.value)([  ])(stream);
        };
    };
};
var fromOm = function (om) {
    return mkStrom(bind(om)(function (value) {
        return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just([ value ])));
    }));
};
var fromArray = function (arr) {
    var $523 = Data_Array["null"](arr);
    if ($523) {
        return mkStrom(pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value)));
    };
    return mkStrom(pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(arr))));
};
var fromFoldable = function (dictFoldable) {
    var $764 = Data_Array.fromFoldable(dictFoldable);
    return function ($765) {
        return fromArray($764($765));
    };
};
var iterateStrom = function (f) {
    return function (initial) {
        return fromArray((function __do() {
            var arr = Data_Array_ST.unsafeThaw([  ])();
            var valRef = {
                value: initial
            };
            var iter = Data_Array_ST_Iterator.iterator(function (i) {
                var $524 = i < 10000;
                if ($524) {
                    return new Data_Maybe.Just(i);
                };
                return Data_Maybe.Nothing.value;
            })();
            Data_Array_ST_Iterator.iterate(iter)(function (v) {
                return function __do() {
                    void1(Data_Array_ST.push(valRef.value)(arr))();
                    return void1(Control_Monad_ST_Internal.modify(f)(valRef))();
                };
            })();
            return Data_Array_ST.unsafeFreeze(arr)();
        })());
    };
};
var repeatStrom = function (a) {
    return fromArray(Data_Array.replicate(10000)(a));
};
var fromAff = function (aff) {
    return mkStrom(bind(liftAff(aff))(function (value) {
        return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just([ value ])));
    }));
};
var foreachParUnordered = function (concurrency) {
    return function (f) {
        return function (stream) {
            return runDrain(mapParUnordered(concurrency)(f)(stream));
        };
    };
};
var foreachPar = function (concurrency) {
    return function (f) {
        return function (stream) {
            return runDrain(mapPar(concurrency)(f)(stream));
        };
    };
};
var forStrom_ = /* #__PURE__ */ Data_Function.flip(traverseStrom_);
var forMStrom_ = forStrom_;
var filterStrom = function (predicate) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                var filtered = Data_Array.filter(predicate)(step.value0.value0);
                return pure(new Control_Monad_Rec_Class.Done((function () {
                    var $527 = Data_Array["null"](filtered);
                    if ($527) {
                        return Data_Maybe.Nothing.value;
                    };
                    return new Data_Maybe.Just(filtered);
                })()));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                var filteredChunk = (function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return Data_Maybe.Nothing.value;
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        var filtered = Data_Array.filter(predicate)(step.value0.value0.value0);
                        var $531 = Data_Array["null"](filtered);
                        if ($531) {
                            return Data_Maybe.Nothing.value;
                        };
                        return new Data_Maybe.Just(filtered);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 545, column 25 - line 550, column 69): " + [ step.value0.value0.constructor.name ]);
                })();
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(filteredChunk, filterStrom(predicate)(step.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 538, column 3 - line 551, column 68): " + [ step.constructor.name ]);
        }));
    };
};
var partition = function (predicate) {
    return function (stream) {
        return new Data_Tuple.Tuple(filterStrom(predicate)(stream), filterStrom(function ($766) {
            return !predicate($766);
        })(stream));
    };
};
var filterMStrom = function (predicate) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return bind(filterA(predicate)(step.value0.value0))(function (filtered) {
                    return pure(new Control_Monad_Rec_Class.Done((function () {
                        var $538 = Data_Array["null"](filtered);
                        if ($538) {
                            return Data_Maybe.Nothing.value;
                        };
                        return new Data_Maybe.Just(filtered);
                    })()));
                });
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return bind((function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return pure(Data_Maybe.Nothing.value);
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        return bind(filterA(predicate)(step.value0.value0.value0))(function (filtered) {
                            return pure((function () {
                                var $542 = Data_Array["null"](filtered);
                                if ($542) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(filtered);
                            })());
                        });
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 672, column 24 - line 676, column 72): " + [ step.value0.value0.constructor.name ]);
                })())(function (filteredChunk) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(filteredChunk, filterMStrom(predicate)(step.value0.value1))));
                });
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 666, column 3 - line 677, column 69): " + [ step.constructor.name ]);
        }));
    };
};
var ensuring = function (finaliser) {
    return function (stream) {
        return mkStrom(bind(Yoga_Om["handleErrors$prime"](function (err) {
            return discard1(finaliser)(function () {
                return throwError1(err);
            });
        })(bind(runStrom(stream))(function (step) {
            return discard1(finaliser)(function () {
                return pure(step);
            });
        })))(function (result) {
            return pure(result);
        }));
    };
};
var empty = /* #__PURE__ */ (function () {
    return mkStrom(pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value)));
})();
var fail = empty;
var groupedStrom = function (size) {
    return function (stream) {
        if (size <= 0) {
            return empty;
        };
        if (Data_Boolean.otherwise) {
            var groupsOf = function (n) {
                return function (arr) {
                    if (n <= 0 || Data_Array["null"](arr)) {
                        return [  ];
                    };
                    if (Data_Boolean.otherwise) {
                        var rest = Data_Array.drop(n)(arr);
                        var group = Data_Array.take(n)(arr);
                        var $551 = Data_Array["null"](group);
                        if ($551) {
                            return [  ];
                        };
                        return Data_Array.cons(group)(groupsOf(n)(rest));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 794, column 7 - line 794, column 62): " + [ n.constructor.name, arr.constructor.name ]);
                };
            };
            var groupedHelper = function (buf) {
                return function (s) {
                    return mkStrom(bind(runStrom(s))(function (step) {
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Done((function () {
                                var $553 = Data_Array["null"](buf);
                                if ($553) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just([ buf ]);
                            })()));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                            var combined = append(buf)(step.value0.value0);
                            var groups = groupsOf(size)(combined);
                            var completeGroups = Data_Array.dropEnd(1)(groups);
                            var lastGroup = (function () {
                                var v = Data_Array.last(groups);
                                if (v instanceof Data_Maybe.Just) {
                                    var $556 = Data_Array.length(v.value0) === size;
                                    if ($556) {
                                        return [ v.value0 ];
                                    };
                                    return [  ];
                                };
                                if (v instanceof Data_Maybe.Nothing) {
                                    return [  ];
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 772, column 27 - line 774, column 30): " + [ v.constructor.name ]);
                            })();
                            var remainder = (function () {
                                var v = Data_Array.last(groups);
                                if (v instanceof Data_Maybe.Just) {
                                    var $559 = Data_Array.length(v.value0) < size;
                                    if ($559) {
                                        return v.value0;
                                    };
                                    return [  ];
                                };
                                if (v instanceof Data_Maybe.Nothing) {
                                    return [  ];
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 775, column 27 - line 777, column 30): " + [ v.constructor.name ]);
                            })();
                            var $561 = Data_Array["null"](remainder);
                            if ($561) {
                                return pure(new Control_Monad_Rec_Class.Done((function () {
                                    var $562 = Data_Array["null"](append(completeGroups)(lastGroup));
                                    if ($562) {
                                        return Data_Maybe.Nothing.value;
                                    };
                                    return new Data_Maybe.Just(append(completeGroups)(lastGroup));
                                })()));
                            };
                            return pure(new Control_Monad_Rec_Class.Done((function () {
                                var $563 = Data_Array["null"](append(completeGroups)([ remainder ]));
                                if ($563) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(append(completeGroups)([ remainder ]));
                            })()));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, groupedHelper(buf)(step.value0.value1))));
                            };
                            if (step.value0.value0 instanceof Data_Maybe.Just) {
                                var combined = append(buf)(step.value0.value0.value0);
                                var groups = groupsOf(size)(combined);
                                var completeGroups = (function () {
                                    var $567 = Data_Array["null"](groups);
                                    if ($567) {
                                        return [  ];
                                    };
                                    return Data_Array.dropEnd(1)(groups);
                                })();
                                var newBuffer = (function () {
                                    var v = Data_Array.last(groups);
                                    if (v instanceof Data_Maybe.Just) {
                                        var $569 = Data_Array.length(v.value0) < size;
                                        if ($569) {
                                            return v.value0;
                                        };
                                        return [  ];
                                    };
                                    if (v instanceof Data_Maybe.Nothing) {
                                        return [  ];
                                    };
                                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 788, column 31 - line 790, column 34): " + [ v.constructor.name ]);
                                })();
                                var $571 = Data_Array["null"](completeGroups);
                                if ($571) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, groupedHelper(newBuffer)(step.value0.value1))));
                                };
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(completeGroups), groupedHelper(newBuffer)(step.value0.value1))));
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 781, column 13 - line 792, column 93): " + [ step.value0.value0.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 762, column 9 - line 792, column 93): " + [ step.constructor.name ]);
                    }));
                };
            };
            return groupedHelper([  ])(stream);
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 755, column 1 - line 755, column 84): " + [ size.constructor.name, stream.constructor.name ]);
    };
};
var mergeAll = function (streams) {
    return Data_Array.foldl(merge)(empty)(streams);
};
var mergeAllNDWith = function (bufferCapacity) {
    return function (streams) {
        if (Data_Array["null"](streams)) {
            return empty;
        };
        if (Data_Boolean.otherwise) {
            return mkStrom(bind(ask)(function (ctx) {
                return liftAff(bind3(liftEffect1(Effect_Ref["new"](Data_CatQueue.empty)))(function (bufferRef) {
                    return bind3(liftEffect1(Effect_Ref["new"](0)))(function (sizeRef) {
                        return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (mutex) {
                            return bind3(Effect_Aff_AVar.empty)(function (notEmpty) {
                                return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (notFull) {
                                    var enqueue = function (item) {
                                        return discard3(Effect_Aff_AVar.take(notFull))(function () {
                                            return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                    var wasEmpty = size === 0;
                                                    return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                        return discard3(liftEffect1(Effect_Ref.write(Data_CatQueue.snoc(buf)(item))(bufferRef)))(function () {
                                                            return discard3(liftEffect1(Effect_Ref.write(size + 1 | 0)(sizeRef)))(function () {
                                                                return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                    return discard3(when1(wasEmpty)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                        return when1((size + 1 | 0) < bufferCapacity)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull));
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    };
                                    var producer = function (s) {
                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(s)))(function (stepResult) {
                                            return bind3(Data_Either.either(function (v) {
                                                return throwError(Effect_Exception.error("Stream error"));
                                            })(pure3)(stepResult))(function (step) {
                                                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                                    return enqueue(MergeDone.value);
                                                };
                                                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                                    return discard3(enqueue(new MergeChunk(step.value0.value0)))(function () {
                                                        return enqueue(MergeDone.value);
                                                    });
                                                };
                                                if (step instanceof Control_Monad_Rec_Class.Loop) {
                                                    return discard3((function () {
                                                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                                                            return enqueue(new MergeChunk(step.value0.value0.value0));
                                                        };
                                                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                                            return pure3(Data_Unit.unit);
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1513, column 17 - line 1515, column 39): " + [ step.value0.value0.constructor.name ]);
                                                    })())(function () {
                                                        return producer(step.value0.value1);
                                                    });
                                                };
                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1507, column 13 - line 1516, column 30): " + [ step.constructor.name ]);
                                            });
                                        });
                                    };
                                    var $lazy_dequeue = $runtime_lazy("dequeue", "Yoga.Om.Strom", function () {
                                        return discard3(Effect_Aff_AVar.take(notEmpty))(function () {
                                            return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                    return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                        var v = Data_CatQueue.uncons(buf);
                                                        if (v instanceof Data_Maybe.Nothing) {
                                                            return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                return $lazy_dequeue(1493);
                                                            });
                                                        };
                                                        if (v instanceof Data_Maybe.Just) {
                                                            return discard3(liftEffect1(Effect_Ref.write(v.value0.value1)(bufferRef)))(function () {
                                                                return discard3(liftEffect1(Effect_Ref.write(size - 1 | 0)(sizeRef)))(function () {
                                                                    var hasMore = (size - 1 | 0) > 0;
                                                                    var wasFull = size === bufferCapacity;
                                                                    return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                        return discard3(when1(hasMore)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                            return discard3(when1(wasFull)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull)))(function () {
                                                                                return pure3(v.value0.value0);
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1490, column 13 - line 1502, column 26): " + [ v.constructor.name ]);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                    var dequeue = $lazy_dequeue(1485);
                                    return bind3(traverse2(function (s) {
                                        return Effect_Aff.forkAff(producer(s));
                                    })(streams))(function (fibers) {
                                        var totalStreams = Data_Array.length(streams);
                                        var consumer = function (doneCount) {
                                            return mkStrom(liftAff((function () {
                                                var $591 = doneCount >= totalStreams;
                                                if ($591) {
                                                    return discard3(traverse_(function (fiber) {
                                                        return Effect_Aff.killFiber(Effect_Exception.error("done"))(fiber);
                                                    })(fibers))(function () {
                                                        return pure3(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                                                    });
                                                };
                                                return bind3(dequeue)(function (msg) {
                                                    if (msg instanceof MergeDone) {
                                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(consumer(doneCount + 1 | 0))))(function (stepResult) {
                                                            return Data_Either.either(function (v) {
                                                                return throwError(Effect_Exception.error("Consumer error"));
                                                            })(pure3)(stepResult);
                                                        });
                                                    };
                                                    if (msg instanceof MergeChunk) {
                                                        return pure3(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(msg.value0), consumer(doneCount))));
                                                    };
                                                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1528, column 15 - line 1533, column 71): " + [ msg.constructor.name ]);
                                                });
                                            })()));
                                        };
                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(consumer(0))))(function (stepResult) {
                                            return Data_Either.either(function (v) {
                                                return throwError(Effect_Exception.error("Consumer init error"));
                                            })(pure3)(stepResult);
                                        });
                                    });
                                });
                            });
                        });
                    });
                }));
            }));
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1460, column 1 - line 1460, column 86): " + [ bufferCapacity.constructor.name, streams.constructor.name ]);
    };
};
var mergeAllND = /* #__PURE__ */ mergeAllNDWith(1024);
var raceAll = function (streams) {
    var v = Data_Array.uncons(streams);
    if (v instanceof Data_Maybe.Nothing) {
        return empty;
    };
    if (v instanceof Data_Maybe.Just) {
        return Data_Array.foldl(mergeHaltEither)(v.value0.head)(v.value0.tail);
    };
    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1319, column 3 - line 1321, column 65): " + [ v.constructor.name ]);
};
var rangeStrom = function (start) {
    return function (end) {
        var rangeHelper = function (current) {
            return function (limit) {
                if (current >= limit) {
                    return empty;
                };
                if (Data_Boolean.otherwise) {
                    return mkStrom((function () {
                        var chunkEnd = min(current + 1000 | 0)(limit);
                        var chunk = Data_Array.range(current)(chunkEnd - 1 | 0);
                        var $600 = chunkEnd >= limit;
                        if ($600) {
                            return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(chunk)));
                        };
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(chunk), rangeHelper(chunkEnd)(limit))));
                    })());
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 266, column 3 - line 274, column 74): " + [ current.constructor.name, limit.constructor.name ]);
            };
        };
        return rangeHelper(start)(end);
    };
};
var repeatOmStrom = function (om) {
    var repeatOmHelper = function (count) {
        if (count >= 100) {
            return empty;
        };
        if (Data_Boolean.otherwise) {
            return mkStrom(bind(om)(function (value) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just([ value ]), repeatOmHelper(count + 1 | 0))));
            }));
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 335, column 3 - line 339, column 73): " + [ count.constructor.name ]);
    };
    return repeatOmHelper(0);
};
var takeStrom = function (n) {
    return function (stream) {
        var takeHelper = function (remaining) {
            return function (s) {
                if (remaining <= 0) {
                    return empty;
                };
                if (Data_Boolean.otherwise) {
                    return mkStrom(bind(runStrom(s))(function (step) {
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                            var taken = Data_Array.take(remaining)(step.value0.value0);
                            var numTaken = Data_Array.length(taken);
                            var $606 = numTaken === 0;
                            if ($606) {
                                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                            };
                            return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(taken)));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, takeHelper(remaining)(step.value0.value1))));
                            };
                            if (step.value0.value0 instanceof Data_Maybe.Just) {
                                var taken = Data_Array.take(remaining)(step.value0.value0.value0);
                                var numTaken = Data_Array.length(taken);
                                var newRemaining = remaining - numTaken | 0;
                                var $610 = numTaken === 0;
                                if ($610) {
                                    return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                                };
                                var $611 = newRemaining <= 0;
                                if ($611) {
                                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(taken)));
                                };
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(taken), takeHelper(newRemaining)(step.value0.value1))));
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 574, column 13 - line 583, column 84): " + [ step.value0.value0.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 565, column 9 - line 583, column 84): " + [ step.constructor.name ]);
                    }));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 561, column 3 - line 583, column 84): " + [ remaining.constructor.name, s.constructor.name ]);
            };
        };
        return takeHelper(n)(stream);
    };
};
var timeout = function (duration) {
    return function (stream) {
        return mkStrom(Yoga_Om.race([ runStrom(stream), applySecond(delay(duration))(runStrom(empty)) ]));
    };
};
var monoidStrom = {
    mempty: empty,
    Semigroup0: function () {
        return semigroupStrom;
    }
};
var dropWhileStrom = function (predicate) {
    return function (stream) {
        var dropWhileHelper = function (stillDropping) {
            return function (s) {
                if (!stillDropping) {
                    return s;
                };
                if (Data_Boolean.otherwise) {
                    return mkStrom(bind(runStrom(s))(function (step) {
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                            var dropped = Data_Array.dropWhile(predicate)(step.value0.value0);
                            return pure(new Control_Monad_Rec_Class.Done((function () {
                                var $620 = Data_Array["null"](dropped);
                                if ($620) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(dropped);
                            })()));
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, dropWhileHelper(stillDropping)(step.value0.value1))));
                            };
                            if (step.value0.value0 instanceof Data_Maybe.Just) {
                                var dropped = Data_Array.dropWhile(predicate)(step.value0.value0.value0);
                                var $624 = Data_Array["null"](dropped);
                                if ($624) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, dropWhileHelper(true)(step.value0.value1))));
                                };
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(dropped), step.value0.value1)));
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 655, column 13 - line 660, column 60): " + [ step.value0.value0.constructor.name ]);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 649, column 9 - line 660, column 60): " + [ step.constructor.name ]);
                    }));
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 645, column 3 - line 660, column 60): " + [ stillDropping.constructor.name, s.constructor.name ]);
            };
        };
        return dropWhileHelper(true)(stream);
    };
};
var dropStrom = function (n) {
    return function (stream) {
        if (n <= 0) {
            return stream;
        };
        if (Data_Boolean.otherwise) {
            var dropHelper = function (remaining) {
                return function (s) {
                    if (remaining <= 0) {
                        return s;
                    };
                    if (Data_Boolean.otherwise) {
                        return mkStrom(bind(runStrom(s))(function (step) {
                            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                            };
                            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                var dropped = Data_Array.drop(remaining)(step.value0.value0);
                                return pure(new Control_Monad_Rec_Class.Done((function () {
                                    var $635 = Data_Array["null"](dropped);
                                    if ($635) {
                                        return Data_Maybe.Nothing.value;
                                    };
                                    return new Data_Maybe.Just(dropped);
                                })()));
                            };
                            if (step instanceof Control_Monad_Rec_Class.Loop) {
                                if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, dropHelper(remaining)(step.value0.value1))));
                                };
                                if (step.value0.value0 instanceof Data_Maybe.Just) {
                                    var chunkLen = Data_Array.length(step.value0.value0.value0);
                                    var $639 = remaining >= chunkLen;
                                    if ($639) {
                                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, dropHelper(remaining - chunkLen | 0)(step.value0.value1))));
                                    };
                                    var dropped = Data_Array.drop(remaining)(step.value0.value0.value0);
                                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(dropped), step.value0.value1)));
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 613, column 17 - line 622, column 65): " + [ step.value0.value0.constructor.name ]);
                            };
                            throw new Error("Failed pattern match at Yoga.Om.Strom (line 607, column 13 - line 622, column 65): " + [ step.constructor.name ]);
                        }));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 603, column 7 - line 622, column 65): " + [ remaining.constructor.name, s.constructor.name ]);
                };
            };
            return dropHelper(n)(stream);
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 598, column 1 - line 598, column 73): " + [ n.constructor.name, stream.constructor.name ]);
    };
};
var delayStrom = function (duration) {
    return function (stream) {
        return mkStrom(discard1(delay(duration))(function () {
            return runStrom(stream);
        }));
    };
};
var debounce = function (duration) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return discard1(delay(duration))(function () {
                    return pure(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(step.value0.value0)));
                });
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, debounce(duration)(step.value0.value1))));
                };
                if (step.value0.value0 instanceof Data_Maybe.Just) {
                    return discard1(delay(duration))(function () {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step.value0.value0.value0), debounce(duration)(step.value0.value1))));
                    });
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 891, column 7 - line 895, column 67): " + [ step.value0.value0.constructor.name ]);
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 885, column 3 - line 895, column 67): " + [ step.constructor.name ]);
        }));
    };
};
var collectStrom = function (f) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                var collected = Data_Array.mapMaybe(f)(step.value0.value0);
                return pure(new Control_Monad_Rec_Class.Done((function () {
                    var $655 = Data_Array["null"](collected);
                    if ($655) {
                        return Data_Maybe.Nothing.value;
                    };
                    return new Data_Maybe.Just(collected);
                })()));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                var collected = (function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return Data_Maybe.Nothing.value;
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        var c = Data_Array.mapMaybe(f)(step.value0.value0.value0);
                        var $659 = Data_Array["null"](c);
                        if ($659) {
                            return Data_Maybe.Nothing.value;
                        };
                        return new Data_Maybe.Just(c);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 690, column 25 - line 694, column 57): " + [ step.value0.value0.constructor.name ]);
                })();
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(collected, collectStrom(f)(step.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 683, column 3 - line 696, column 59): " + [ step.constructor.name ]);
        }));
    };
};
var partitionMap = function (f) {
    return function (stream) {
        var rightOnly = function (x) {
            var v = f(x);
            if (v instanceof Data_Either.Left) {
                return Data_Maybe.Nothing.value;
            };
            if (v instanceof Data_Either.Right) {
                return new Data_Maybe.Just(v.value0);
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 870, column 23 - line 872, column 28): " + [ v.constructor.name ]);
        };
        var leftOnly = function (x) {
            var v = f(x);
            if (v instanceof Data_Either.Left) {
                return new Data_Maybe.Just(v.value0);
            };
            if (v instanceof Data_Either.Right) {
                return Data_Maybe.Nothing.value;
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 867, column 22 - line 869, column 29): " + [ v.constructor.name ]);
        };
        return new Data_Tuple.Tuple(collectStrom(leftOnly)(stream), collectStrom(rightOnly)(stream));
    };
};
var collectMStrom = function (f) {
    return function (stream) {
        return mkStrom(bind(runStrom(stream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return bind(traverse1(f)(step.value0.value0))(function (maybes) {
                    var collected = Data_Array.mapMaybe(identity)(maybes);
                    return pure(new Control_Monad_Rec_Class.Done((function () {
                        var $672 = Data_Array["null"](collected);
                        if ($672) {
                            return Data_Maybe.Nothing.value;
                        };
                        return new Data_Maybe.Just(collected);
                    })()));
                });
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return bind((function () {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return pure(Data_Maybe.Nothing.value);
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        return bind(traverse1(f)(step.value0.value0.value0))(function (maybes) {
                            var c = Data_Array.mapMaybe(identity)(maybes);
                            return pure((function () {
                                var $676 = Data_Array["null"](c);
                                if ($676) {
                                    return Data_Maybe.Nothing.value;
                                };
                                return new Data_Maybe.Just(c);
                            })());
                        });
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 709, column 20 - line 714, column 58): " + [ step.value0.value0.constructor.name ]);
                })())(function (collected) {
                    return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(collected, collectMStrom(f)(step.value0.value1))));
                });
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 702, column 3 - line 715, column 58): " + [ step.constructor.name ]);
        }));
    };
};
var chunkedStrom = groupedStrom;
var changesStrom = function (dictEq) {
    var eq2 = Data_Eq.eq(Data_Maybe.eqMaybe(dictEq));
    return function (stream) {
        var changesHelper = function (lastSeen) {
            return function (s) {
                return mkStrom(bind(runStrom(s))(function (step) {
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                        var v = Data_Array.foldl(function (v1) {
                            return function (curr) {
                                var $684 = eq2(new Data_Maybe.Just(curr))(v1.value0);
                                if ($684) {
                                    return new Data_Tuple.Tuple(new Data_Maybe.Just(curr), v1.value1);
                                };
                                return new Data_Tuple.Tuple(new Data_Maybe.Just(curr), Data_Array.snoc(v1.value1)(curr));
                            };
                        })(new Data_Tuple.Tuple(lastSeen, [  ]))(step.value0.value0);
                        return pure(new Control_Monad_Rec_Class.Done((function () {
                            var $688 = Data_Array["null"](v.value1);
                            if ($688) {
                                return Data_Maybe.Nothing.value;
                            };
                            return new Data_Maybe.Just(v.value1);
                        })()));
                    };
                    if (step instanceof Control_Monad_Rec_Class.Loop) {
                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, changesHelper(lastSeen)(step.value0.value1))));
                        };
                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                            var v = Data_Array.foldl(function (v1) {
                                return function (curr) {
                                    var $695 = eq2(new Data_Maybe.Just(curr))(v1.value0);
                                    if ($695) {
                                        return new Data_Tuple.Tuple(new Data_Maybe.Just(curr), v1.value1);
                                    };
                                    return new Data_Tuple.Tuple(new Data_Maybe.Just(curr), Data_Array.snoc(v1.value1)(curr));
                                };
                            })(new Data_Tuple.Tuple(lastSeen, [  ]))(step.value0.value0.value0);
                            var $699 = Data_Array["null"](v.value1);
                            if ($699) {
                                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, changesHelper(v.value0)(step.value0.value1))));
                            };
                            return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(v.value1), changesHelper(v.value0)(step.value0.value1))));
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 736, column 9 - line 748, column 79): " + [ step.value0.value0.constructor.name ]);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 723, column 5 - line 748, column 79): " + [ step.constructor.name ]);
                }));
            };
        };
        return changesHelper(Data_Maybe.Nothing.value)(stream);
    };
};
var catchAll = function (handler) {
    return function (stream) {
        return mkStrom(Yoga_Om["handleErrors$prime"](function (err) {
            return runStrom(handler(err));
        })(runStrom(stream)));
    };
};
var retryN = function (n) {
    return function (stream) {
        if (n <= 0) {
            return stream;
        };
        if (Data_Boolean.otherwise) {
            return catchAll(function (v) {
                return retryN(n - 1 | 0)(stream);
            })(stream);
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1617, column 1 - line 1617, column 70): " + [ n.constructor.name, stream.constructor.name ]);
    };
};
var retry = /* #__PURE__ */ retryN(3);
var bufferChunks = function (capacity) {
    return function (stream) {
        if (capacity <= 0) {
            return stream;
        };
        if (Data_Boolean.otherwise) {
            return mkStrom(bind(ask)(function (ctx) {
                return liftAff(bind3(liftEffect1(Effect_Ref["new"](Data_CatQueue.empty)))(function (bufferRef) {
                    return bind3(liftEffect1(Effect_Ref["new"](0)))(function (sizeRef) {
                        return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (mutex) {
                            return bind3(Effect_Aff_AVar.empty)(function (notEmpty) {
                                return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (notFull) {
                                    var enqueue = function (item) {
                                        return discard3(Effect_Aff_AVar.take(notFull))(function () {
                                            return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                    var wasEmpty = size === 0;
                                                    return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                        return discard3(liftEffect1(Effect_Ref.write(Data_CatQueue.snoc(buf)(item))(bufferRef)))(function () {
                                                            return discard3(liftEffect1(Effect_Ref.write(size + 1 | 0)(sizeRef)))(function () {
                                                                return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                    return discard3(when1(wasEmpty)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                        return when1((size + 1 | 0) < capacity)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull));
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    };
                                    var producer = function (s) {
                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(s)))(function (stepResult) {
                                            return bind3(Data_Either.either(function (v) {
                                                return throwError(Effect_Exception.error("Stream error"));
                                            })(pure3)(stepResult))(function (step) {
                                                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                                    return enqueue(BufferDone.value);
                                                };
                                                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                                    return discard3(enqueue(new BufferChunk(step.value0.value0)))(function () {
                                                        return enqueue(BufferDone.value);
                                                    });
                                                };
                                                if (step instanceof Control_Monad_Rec_Class.Loop) {
                                                    return discard3((function () {
                                                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                                                            return enqueue(new BufferChunk(step.value0.value0.value0));
                                                        };
                                                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                                            return pure3(Data_Unit.unit);
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1183, column 17 - line 1185, column 39): " + [ step.value0.value0.constructor.name ]);
                                                    })())(function () {
                                                        return producer(step.value0.value1);
                                                    });
                                                };
                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1177, column 13 - line 1186, column 30): " + [ step.constructor.name ]);
                                            });
                                        });
                                    };
                                    var $lazy_dequeue = $runtime_lazy("dequeue", "Yoga.Om.Strom", function () {
                                        return discard3(Effect_Aff_AVar.take(notEmpty))(function () {
                                            return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                    return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                        var v = Data_CatQueue.uncons(buf);
                                                        if (v instanceof Data_Maybe.Nothing) {
                                                            return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                return $lazy_dequeue(1163);
                                                            });
                                                        };
                                                        if (v instanceof Data_Maybe.Just) {
                                                            return discard3(liftEffect1(Effect_Ref.write(v.value0.value1)(bufferRef)))(function () {
                                                                return discard3(liftEffect1(Effect_Ref.write(size - 1 | 0)(sizeRef)))(function () {
                                                                    var hasMore = (size - 1 | 0) > 0;
                                                                    var wasFull = size === capacity;
                                                                    return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                        return discard3(when1(hasMore)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                            return discard3(when1(wasFull)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull)))(function () {
                                                                                return pure3(v.value0.value0);
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1160, column 13 - line 1172, column 26): " + [ v.constructor.name ]);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                    var dequeue = $lazy_dequeue(1155);
                                    return bind3(Effect_Aff.forkAff(producer(stream)))(function (fiber) {
                                        var $lazy_consumer = $runtime_lazy("consumer", "Yoga.Om.Strom", function () {
                                            return mkStrom(liftAff(bind3(dequeue)(function (msg) {
                                                if (msg instanceof BufferDone) {
                                                    return discard3(Effect_Aff.killFiber(Effect_Exception.error("done"))(fiber))(function () {
                                                        return pure3(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                                                    });
                                                };
                                                if (msg instanceof BufferChunk) {
                                                    return pure3(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(msg.value0), $lazy_consumer(1198))));
                                                };
                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1193, column 13 - line 1198, column 57): " + [ msg.constructor.name ]);
                                            })));
                                        });
                                        var consumer = $lazy_consumer(1191);
                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(consumer)))(function (stepResult) {
                                            return Data_Either.either(function (v) {
                                                return throwError(Effect_Exception.error("Consumer init error"));
                                            })(pure3)(stepResult);
                                        });
                                    });
                                });
                            });
                        });
                    });
                }));
            }));
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1130, column 1 - line 1130, column 76): " + [ capacity.constructor.name, stream.constructor.name ]);
    };
};
var buffer = function (capacity) {
    return function (stream) {
        if (capacity <= 0) {
            return stream;
        };
        if (Data_Boolean.otherwise) {
            return mkStrom(bind(ask)(function (ctx) {
                return liftAff(bind3(liftEffect1(Effect_Ref["new"](Data_CatQueue.empty)))(function (bufferRef) {
                    return bind3(liftEffect1(Effect_Ref["new"](0)))(function (sizeRef) {
                        return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (mutex) {
                            return bind3(Effect_Aff_AVar.empty)(function (notEmpty) {
                                return bind3(Effect_Aff_AVar["new"](Data_Unit.unit))(function (notFull) {
                                    var enqueue = function (item) {
                                        return discard3(Effect_Aff_AVar.take(notFull))(function () {
                                            return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                    var wasEmpty = size === 0;
                                                    return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                        return discard3(liftEffect1(Effect_Ref.write(Data_CatQueue.snoc(buf)(item))(bufferRef)))(function () {
                                                            return discard3(liftEffect1(Effect_Ref.write(size + 1 | 0)(sizeRef)))(function () {
                                                                return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                    return discard3(when1(wasEmpty)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                        return when1((size + 1 | 0) < capacity)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull));
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    };
                                    var producer = function (s) {
                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(s)))(function (stepResult) {
                                            return bind3(Data_Either.either(function (v) {
                                                return throwError(Effect_Exception.error("Stream error"));
                                            })(pure3)(stepResult))(function (step) {
                                                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                                                    return enqueue(BufferDone.value);
                                                };
                                                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                                                    return discard3(traverse_(function (a) {
                                                        return enqueue(new BufferChunk([ a ]));
                                                    })(step.value0.value0))(function () {
                                                        return enqueue(BufferDone.value);
                                                    });
                                                };
                                                if (step instanceof Control_Monad_Rec_Class.Loop) {
                                                    return discard3((function () {
                                                        if (step.value0.value0 instanceof Data_Maybe.Just) {
                                                            return traverse_(function (a) {
                                                                return enqueue(new BufferChunk([ a ]));
                                                            })(step.value0.value0.value0);
                                                        };
                                                        if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                                                            return pure3(Data_Unit.unit);
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1257, column 17 - line 1259, column 39): " + [ step.value0.value0.constructor.name ]);
                                                    })())(function () {
                                                        return producer(step.value0.value1);
                                                    });
                                                };
                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1251, column 13 - line 1260, column 30): " + [ step.constructor.name ]);
                                            });
                                        });
                                    };
                                    var $lazy_dequeue = $runtime_lazy("dequeue", "Yoga.Om.Strom", function () {
                                        return discard3(Effect_Aff_AVar.take(notEmpty))(function () {
                                            return discard3(Effect_Aff_AVar.take(mutex))(function () {
                                                return bind3(liftEffect1(Effect_Ref.read(bufferRef)))(function (buf) {
                                                    return bind3(liftEffect1(Effect_Ref.read(sizeRef)))(function (size) {
                                                        var v = Data_CatQueue.uncons(buf);
                                                        if (v instanceof Data_Maybe.Nothing) {
                                                            return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                return $lazy_dequeue(1237);
                                                            });
                                                        };
                                                        if (v instanceof Data_Maybe.Just) {
                                                            return discard3(liftEffect1(Effect_Ref.write(v.value0.value1)(bufferRef)))(function () {
                                                                return discard3(liftEffect1(Effect_Ref.write(size - 1 | 0)(sizeRef)))(function () {
                                                                    var hasMore = (size - 1 | 0) > 0;
                                                                    var wasFull = size === capacity;
                                                                    return discard3(Effect_Aff_AVar.put(Data_Unit.unit)(mutex))(function () {
                                                                        return discard3(when1(hasMore)(Effect_Aff_AVar.put(Data_Unit.unit)(notEmpty)))(function () {
                                                                            return discard3(when1(wasFull)(Effect_Aff_AVar.put(Data_Unit.unit)(notFull)))(function () {
                                                                                return pure3(v.value0.value0);
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        };
                                                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1234, column 13 - line 1246, column 26): " + [ v.constructor.name ]);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                    var dequeue = $lazy_dequeue(1229);
                                    return bind3(Effect_Aff.forkAff(producer(stream)))(function (fiber) {
                                        var $lazy_consumer = $runtime_lazy("consumer", "Yoga.Om.Strom", function () {
                                            return mkStrom(liftAff(bind3(dequeue)(function (msg) {
                                                if (msg instanceof BufferDone) {
                                                    return discard3(Effect_Aff.killFiber(Effect_Exception.error("done"))(fiber))(function () {
                                                        return pure3(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                                                    });
                                                };
                                                if (msg instanceof BufferChunk) {
                                                    return pure3(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(msg.value0), $lazy_consumer(1272))));
                                                };
                                                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1267, column 13 - line 1272, column 57): " + [ msg.constructor.name ]);
                                            })));
                                        });
                                        var consumer = $lazy_consumer(1265);
                                        return bind3(Yoga_Om.runReader(ctx)(runStrom(consumer)))(function (stepResult) {
                                            return Data_Either.either(function (v) {
                                                return throwError(Effect_Exception.error("Consumer init error"));
                                            })(pure3)(stepResult);
                                        });
                                    });
                                });
                            });
                        });
                    });
                }));
            }));
        };
        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1204, column 1 - line 1204, column 70): " + [ capacity.constructor.name, stream.constructor.name ]);
    };
};
var bracketExit = function (acquire) {
    return function (release) {
        return function (use) {
            return mkStrom(bind(acquire)(function (resource) {
                return bind(Yoga_Om["handleErrors$prime"](function (err) {
                    return discard1(release(resource)(new Data_Maybe.Just(err)))(function () {
                        return throwError1(err);
                    });
                })(runStrom(use(resource))))(function (step) {
                    return discard1((function () {
                        if (step instanceof Control_Monad_Rec_Class.Done) {
                            return release(resource)(Data_Maybe.Nothing.value);
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            return pure(Data_Unit.unit);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1684, column 7 - line 1686, column 28): " + [ step.constructor.name ]);
                    })())(function () {
                        return pure(step);
                    });
                });
            }));
        };
    };
};
var bracket = function (acquire) {
    return function (release) {
        return function (use) {
            return mkStrom(bind(acquire)(function (resource) {
                return bind(Yoga_Om["handleErrors$prime"](function (err) {
                    return discard1(release(resource))(function () {
                        return throwError1(err);
                    });
                })(runStrom(use(resource))))(function (step) {
                    return discard1((function () {
                        if (step instanceof Control_Monad_Rec_Class.Done) {
                            return release(resource);
                        };
                        if (step instanceof Control_Monad_Rec_Class.Loop) {
                            return pure(Data_Unit.unit);
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom (line 1663, column 7 - line 1665, column 28): " + [ step.constructor.name ]);
                    })())(function () {
                        return pure(step);
                    });
                });
            }));
        };
    };
};
var appendStrom = function (toAppend) {
    return function (baseStream) {
        return mkStrom(bind(runStrom(baseStream))(function (step) {
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                return runStrom(toAppend);
            };
            if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(step.value0.value0), toAppend)));
            };
            if (step instanceof Control_Monad_Rec_Class.Loop) {
                return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(step.value0.value0, appendStrom(toAppend)(step.value0.value1))));
            };
            throw new Error("Failed pattern match at Yoga.Om.Strom (line 1047, column 3 - line 1050, column 93): " + [ step.constructor.name ]);
        }));
    };
};
var concatStrom = function (streams) {
    return Data_Array.foldr(Data_Function.flip(appendStrom))(empty)(streams);
};
var bindStrom1 = {
    bind: function (stream) {
        return function (f) {
            return mkStrom(bind(runStrom(stream))(function (step) {
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                    return pure(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                };
                if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                    var streams = map(f)(step.value0.value0);
                    return runStrom(concatStrom(streams));
                };
                if (step instanceof Control_Monad_Rec_Class.Loop) {
                    if (step.value0.value0 instanceof Data_Maybe.Nothing) {
                        return pure(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(Data_Maybe.Nothing.value, Control_Bind.bind(bindStrom1)(step.value0.value1)(f))));
                    };
                    if (step.value0.value0 instanceof Data_Maybe.Just) {
                        var streams = map(f)(step.value0.value0.value0);
                        var prefixStream = concatStrom(streams);
                        return runStrom(appendStrom(prefixStream)(Control_Bind.bind(bindStrom1)(step.value0.value1)(f)));
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom (line 1754, column 13 - line 1760, column 67): " + [ step.value0.value0.constructor.name ]);
                };
                throw new Error("Failed pattern match at Yoga.Om.Strom (line 1746, column 9 - line 1760, column 67): " + [ step.constructor.name ]);
            }));
        };
    },
    Apply0: function () {
        return applyStrom;
    }
};
var bind4 = /* #__PURE__ */ Control_Bind.bind(bindStrom1);
var bindStrom = function (f) {
    return function (stream) {
        return bind4(stream)(f);
    };
};
var monadStrom = {
    Applicative0: function () {
        return applicativeStrom;
    },
    Bind1: function () {
        return bindStrom1;
    }
};
var acquireRelease = bracket;
export {
    empty,
    succeed,
    fail,
    fromAff,
    fromOm,
    fromArray,
    fromFoldable,
    rangeStrom,
    iterateStrom,
    iterateStromInfinite,
    repeatStrom,
    repeatStromInfinite,
    repeatOmStrom,
    repeatOmStromInfinite,
    unfoldStrom,
    unfoldOmStrom,
    runCollect,
    runDrain,
    runFold,
    traverseStrom_,
    forStrom_,
    forMStrom_,
    traverseMStrom_,
    mapStrom,
    mapMStrom,
    bindStrom,
    scanStrom,
    mapAccumStrom,
    tapStrom,
    tapMStrom,
    filterStrom,
    takeStrom,
    takeWhileStrom,
    takeUntilStrom,
    dropStrom,
    dropWhileStrom,
    filterMStrom,
    collectStrom,
    collectMStrom,
    changesStrom,
    groupedStrom,
    chunkedStrom,
    groupByStrom,
    partition,
    partitionMap,
    debounce,
    throttle,
    delayStrom,
    appendStrom,
    concatStrom,
    zipStrom,
    zipWithStrom,
    interleave,
    intersperse,
    HaltBoth,
    HaltEither,
    HaltLeft,
    HaltRight,
    merge,
    mergeAll,
    mergeWith,
    mergeHaltEither,
    mergeHaltLeft,
    mergeHaltRight,
    mergeND,
    mergeNDWith,
    mergeAllND,
    mergeAllNDWith,
    race,
    raceAll,
    mapPar,
    mapMPar,
    foreachPar,
    mapParUnordered,
    mapMParUnordered,
    foreachParUnordered,
    buffer,
    bufferChunks,
    catchAll,
    retry,
    retryN,
    timeout,
    ensuring,
    bracket,
    bracketExit,
    acquireRelease,
    mkStrom,
    runStrom,
    eqHaltStrategy,
    functorStrom,
    applyStrom,
    applicativeStrom,
    bindStrom1,
    monadStrom,
    semigroupStrom,
    monoidStrom,
    altStrom,
    plusStrom,
    alternativeStrom
};
//# sourceMappingURL=index.js.map
