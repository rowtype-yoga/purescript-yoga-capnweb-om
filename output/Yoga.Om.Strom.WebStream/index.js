// Generated by purs version 0.15.15
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Error_Class from "../Control.Monad.Error.Class/index.js";
import * as Control_Monad_Reader_Class from "../Control.Monad.Reader.Class/index.js";
import * as Control_Monad_Rec_Class from "../Control.Monad.Rec.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Aff_Compat from "../Effect.Aff.Compat/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Exception from "../Effect.Exception/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Yoga_Om from "../Yoga.Om/index.js";
import * as Yoga_Om_Strom from "../Yoga.Om.Strom/index.js";
var $runtime_lazy = function (name, moduleName, init) {
    var state = 0;
    var val;
    return function (lineNumber) {
        if (state === 2) return val;
        if (state === 1) throw new ReferenceError(name + " was needed before it finished initializing (module " + moduleName + ", line " + lineNumber + ")", moduleName, lineNumber);
        state = 1;
        val = init();
        state = 2;
        return val;
    };
};
var bind1 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var when = /* #__PURE__ */ Control_Applicative.when(Effect_Aff.applicativeAff);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var traverse_ = /* #__PURE__ */ Data_Foldable.traverse_(Effect.applicativeEffect)(Data_Foldable.foldableArray);
var discard2 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var $$try = /* #__PURE__ */ Control_Monad_Error_Class["try"](Effect_Aff.monadErrorAff);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var $$void = /* #__PURE__ */ Data_Functor["void"](Effect.functorEffect);
var bind2 = /* #__PURE__ */ Control_Bind.bind(Yoga_Om.bindOm);
var liftAff = /* #__PURE__ */ Effect_Aff_Class.liftAff(Yoga_Om.monadAffOm);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Yoga_Om.applicativeOm);
var ask = /* #__PURE__ */ Control_Monad_Reader_Class.ask(Yoga_Om.monadAskOm);
var when1 = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var throwError = /* #__PURE__ */ Control_Monad_Error_Class.throwError(Yoga_Om.monadThrowVariantExceptio);
var liftEffect1 = /* #__PURE__ */ Effect_Class.liftEffect(Yoga_Om.monadEffectOm);
var traverse_1 = /* #__PURE__ */ Data_Foldable.traverse_(Yoga_Om.applicativeOm)(Data_Foldable.foldableArray);
var discard3 = /* #__PURE__ */ discard(Yoga_Om.bindOm);
var writerReady = function (writer) {
    return Effect_Aff_Compat.fromEffectFnAff($foreign["_writerReadyImpl"](writer));
};
var writeWriter = function (writer) {
    return function (value) {
        return Effect_Aff_Compat.fromEffectFnAff($foreign["_writeWriterImpl"](writer)(value));
    };
};
var stromToReadableStream = function (cleanup) {
    return function (ctx) {
        return function (strom) {
            return function __do() {
                var stromRef = Effect_Ref["new"](strom)();
                var fiberRef = Effect_Ref["new"](Data_Maybe.Nothing.value)();
                var cancelledRef = Effect_Ref["new"](false)();
                var pullLoop = function (controller) {
                    return bind1(liftEffect(Effect_Ref.read(cancelledRef)))(function (cancelled) {
                        return when(!cancelled)(bind1(liftEffect(Effect_Ref.read(stromRef)))(function (currentStrom) {
                            return bind1(Yoga_Om.runReader(ctx)(Yoga_Om_Strom.runStrom(currentStrom)))(function (result) {
                                if (result instanceof Data_Either.Left) {
                                    return liftEffect(function __do() {
                                        cleanup();
                                        return $foreign["_errorController"](controller)($foreign["_variantToError"](result.value0))();
                                    });
                                };
                                if (result instanceof Data_Either.Right) {
                                    if (result.value0 instanceof Control_Monad_Rec_Class.Done && result.value0.value0 instanceof Data_Maybe.Nothing) {
                                        return liftEffect(function __do() {
                                            cleanup();
                                            return $foreign["_closeController"](controller)();
                                        });
                                    };
                                    if (result.value0 instanceof Control_Monad_Rec_Class.Done && result.value0.value0 instanceof Data_Maybe.Just) {
                                        return liftEffect(function __do() {
                                            traverse_($foreign["_enqueue"](controller))(result.value0.value0.value0)();
                                            cleanup();
                                            return $foreign["_closeController"](controller)();
                                        });
                                    };
                                    if (result.value0 instanceof Control_Monad_Rec_Class.Loop) {
                                        return discard2(liftEffect(Effect_Ref.write(result.value0.value0.value1)(stromRef)))(function () {
                                            if (result.value0.value0.value0 instanceof Data_Maybe.Nothing) {
                                                return pullLoop(controller);
                                            };
                                            if (result.value0.value0.value0 instanceof Data_Maybe.Just) {
                                                return liftEffect(traverse_($foreign["_enqueue"](controller))(result.value0.value0.value0.value0));
                                            };
                                            throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 147, column 15 - line 149, column 81): " + [ result.value0.value0.value0.constructor.name ]);
                                        });
                                    };
                                    throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 137, column 25 - line 149, column 81): " + [ result.value0.constructor.name ]);
                                };
                                throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 133, column 9 - line 149, column 81): " + [ result.constructor.name ]);
                            });
                        }));
                    });
                };
                var pull = function (controller) {
                    return $foreign["_makePromise"](function (resolve) {
                        return function (_reject) {
                            return function __do() {
                                var fiber = Effect_Aff.launchAff(bind1($$try(pullLoop(controller)))(function (result) {
                                    return liftEffect(function __do() {
                                        (function () {
                                            if (result instanceof Data_Either.Left) {
                                                return cleanup();
                                            };
                                            if (result instanceof Data_Either.Right) {
                                                return Data_Unit.unit;
                                            };
                                            throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 157, column 13 - line 163, column 35): " + [ result.constructor.name ]);
                                        })();
                                        return resolve(Data_Unit.unit)();
                                    });
                                }))();
                                return Effect_Ref.write(new Data_Maybe.Just(fiber))(fiberRef)();
                            };
                        };
                    });
                };
                var cancel = function __do() {
                    Effect_Ref.write(true)(cancelledRef)();
                    var maybeFiber = Effect_Ref.read(fiberRef)();
                    (function () {
                        if (maybeFiber instanceof Data_Maybe.Nothing) {
                            return Data_Unit.unit;
                        };
                        if (maybeFiber instanceof Data_Maybe.Just) {
                            return $$void(Effect_Aff.launchAff(Effect_Aff.killFiber(Effect_Exception.error("cancelled"))(maybeFiber.value0)))();
                        };
                        throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 173, column 7 - line 176, column 75): " + [ maybeFiber.constructor.name ]);
                    })();
                    var _currentStrom = Effect_Ref.read(stromRef)();
                    Data_Unit.unit;
                    return cleanup();
                };
                return $foreign["_newReadableStream"](pull)(cancel)();
            };
        };
    };
};
var toReadableStream = /* #__PURE__ */ stromToReadableStream(/* #__PURE__ */ pure(Data_Unit.unit));
var readBatch = function (reader) {
    return function (batchSize) {
        return Effect_Aff_Compat.fromEffectFnAff($foreign["_readBatchImpl"](reader)(batchSize));
    };
};
var readerToStromWithCleanupAndSize = function (batchSize) {
    return function (_cleanup) {
        return function (reader) {
            var $lazy_go = $runtime_lazy("go", "Yoga.Om.Strom.WebStream", function () {
                return Yoga_Om_Strom.mkStrom(bind2(liftAff(readBatch(reader)(batchSize)))(function (result) {
                    var values = $foreign["_batchResultValues"](result);
                    var done = $foreign["_batchResultDone"](result);
                    if (done) {
                        var $45 = Data_Array["null"](values);
                        if ($45) {
                            return pure1(new Control_Monad_Rec_Class.Done(Data_Maybe.Nothing.value));
                        };
                        return pure1(new Control_Monad_Rec_Class.Done(new Data_Maybe.Just(values)));
                    };
                    return pure1(new Control_Monad_Rec_Class.Loop(new Data_Tuple.Tuple(new Data_Maybe.Just(values), $lazy_go(309))));
                }));
            });
            var go = $lazy_go(300);
            return go;
        };
    };
};
var readerToStrom = function (batchSize) {
    return function (reader) {
        return readerToStromWithCleanupAndSize(batchSize)($foreign["_releaseReader"](reader))(reader);
    };
};
var useReadableStreamWith = function (v) {
    return function (stream) {
        return function (callback) {
            return bind2(ask)(function (ctx) {
                return bind2(liftAff(Effect_Aff.bracket(liftEffect(function __do() {
                    var reader = $foreign["_getReader"](stream)();
                    var releasedRef = Effect_Ref["new"](false)();
                    return {
                        reader: reader,
                        releasedRef: releasedRef
                    };
                }))(function (v1) {
                    return bind1(liftEffect(Effect_Ref.read(v1.releasedRef)))(function (alreadyReleased) {
                        return when(!alreadyReleased)(discard2(liftEffect(Effect_Ref.write(true)(v1.releasedRef)))(function () {
                            return Effect_Aff_Compat.fromEffectFnAff($foreign["_cancelReaderImpl"](v1.reader));
                        }));
                    });
                })(function (v1) {
                    var releaseOnce = function __do() {
                        var alreadyReleased = Effect_Ref.read(v1.releasedRef)();
                        return when1(!alreadyReleased)(function __do() {
                            Effect_Ref.write(true)(v1.releasedRef)();
                            return $foreign["_releaseReader"](v1.reader)();
                        })();
                    };
                    var inputStrom = readerToStromWithCleanupAndSize(v.chunkSize)(releaseOnce)(v1.reader);
                    return Yoga_Om.runReader(ctx)(callback(inputStrom));
                })))(function (result) {
                    if (result instanceof Data_Either.Left) {
                        return throwError(result.value0);
                    };
                    if (result instanceof Data_Either.Right) {
                        return pure1(result.value0);
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 358, column 3 - line 360, column 30): " + [ result.constructor.name ]);
                });
            });
        };
    };
};
var fromReadableStreamWith = function (v) {
    return function (stream) {
        return Yoga_Om_Strom.mkStrom(bind2(liftEffect1($foreign["_getReader"](stream)))(function (reader) {
            return Yoga_Om_Strom.runStrom(readerToStrom(v.chunkSize)(reader));
        }));
    };
};
var defaultChunkSize = 1000;
var fromReadableStream = /* #__PURE__ */ fromReadableStreamWith({
    chunkSize: defaultChunkSize
});
var pipeThrough = function (ctx) {
    return function (transform) {
        return function (readable) {
            return function __do() {
                var reader = $foreign["_getReader"](readable)();
                var releasedRef = Effect_Ref["new"](false)();
                var releaseOnce = function __do() {
                    var alreadyReleased = Effect_Ref.read(releasedRef)();
                    return when1(!alreadyReleased)(function __do() {
                        Effect_Ref.write(true)(releasedRef)();
                        return $foreign["_releaseReader"](reader)();
                    })();
                };
                var inputStrom = readerToStromWithCleanupAndSize(defaultChunkSize)(releaseOnce)(reader);
                return stromToReadableStream(releaseOnce)(ctx)(transform(inputStrom))();
            };
        };
    };
};
var useReadableStream = /* #__PURE__ */ useReadableStreamWith({
    chunkSize: defaultChunkSize
});
var closeWriter = function (writer) {
    return Effect_Aff_Compat.fromEffectFnAff($foreign["_closeWriterImpl"](writer));
};
var runWritable = function (writable) {
    return function (strom) {
        var writeElement = function (writer) {
            return function (value) {
                return liftAff(discard2(writerReady(writer))(function () {
                    return writeWriter(writer)(value);
                }));
            };
        };
        var writeChunk = function (writer) {
            return function (chunk) {
                return traverse_1(writeElement(writer))(chunk);
            };
        };
        var go = function (writer) {
            return function (s) {
                return bind2(Yoga_Om_Strom.runStrom(s))(function (step) {
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Nothing) {
                        return pure1(Data_Unit.unit);
                    };
                    if (step instanceof Control_Monad_Rec_Class.Done && step.value0 instanceof Data_Maybe.Just) {
                        return writeChunk(writer)(step.value0.value0);
                    };
                    if (step instanceof Control_Monad_Rec_Class.Loop) {
                        return discard3(Data_Maybe.maybe(pure1(Data_Unit.unit))(writeChunk(writer))(step.value0.value0))(function () {
                            return go(writer)(step.value0.value1);
                        });
                    };
                    throw new Error("Failed pattern match at Yoga.Om.Strom.WebStream (line 247, column 5 - line 252, column 23): " + [ step.constructor.name ]);
                });
            };
        };
        return bind2(liftEffect1($foreign["_getWriter"](writable)))(function (writer) {
            return Yoga_Om["handleErrors$prime"](function (err) {
                return bind2(liftAff($$try(closeWriter(writer))))(function () {
                    return throwError(err);
                });
            })(discard3(go(writer)(strom))(function () {
                return liftAff(closeWriter(writer));
            }));
        });
    };
};
export {
    toReadableStream,
    fromReadableStream,
    fromReadableStreamWith,
    useReadableStream,
    useReadableStreamWith,
    runWritable,
    pipeThrough
};
//# sourceMappingURL=index.js.map
